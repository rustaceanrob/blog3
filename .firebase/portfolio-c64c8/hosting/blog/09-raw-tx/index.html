<!DOCTYPE html><html lang="en"> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" type="image/svg+xml" href="/rust.png" media="(prefers-color-scheme: dark)"><link rel="icon" type="image/svg+xml" href="/rust.png" media="(prefers-color-scheme: light)"><link rel="icon" type="image/x-icon" href="/rust.png"><meta name="generator" content="Astro v4.15.4"><!-- Font preloads --><link rel="preload" href="/_astro/inter-latin-400-normal.BT1H-PT_.woff2" as="font" type="font/woff2" crossorigin><link rel="preload" href="/_astro/inter-latin-600-normal.B2Ssfs8e.woff2" as="font" type="font/woff2" crossorigin><link rel="preload" href="/_astro/lora-latin-400-normal.CvHVDnm4.woff2" as="font" type="font/woff2" crossorigin><link rel="preload" href="/_astro/lora-latin-600-normal.DUWh3m6k.woff2" as="font" type="font/woff2" crossorigin><!-- Canonical URL --><link rel="canonical" href="https://robnetzke.com/blog/09-raw-tx/"><!-- Primary Meta Tags --><title>Bitcoin Transactions from 0 and 1 | @rustaceanrob</title><meta name="title" content="Bitcoin Transactions from 0 and 1 | @rustaceanrob"><meta name="description" content="Constructing transations from raw bytes of data."><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://robnetzke.com/blog/09-raw-tx/"><meta property="og:title" content="Bitcoin Transactions from 0 and 1 | @rustaceanrob"><meta property="og:description" content="Constructing transations from raw bytes of data."><meta property="og:image" content="https://robnetzke.com/nano.png"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://robnetzke.com/blog/09-raw-tx/"><meta property="twitter:title" content="Bitcoin Transactions from 0 and 1 | @rustaceanrob"><meta property="twitter:description" content="Constructing transations from raw bytes of data."><meta property="twitter:image" content="https://robnetzke.com/nano.png"><meta name="astro-view-transitions-enabled" content="true"><meta name="astro-view-transitions-fallback" content="animate"><script>
  function init() {
    preloadTheme();
    onScroll();
    animate();

    const backToTop = document.getElementById("back-to-top");
    backToTop?.addEventListener("click", (event) => scrollToTop(event));

    const backToPrev = document.getElementById("back-to-prev");
    backToPrev?.addEventListener("click", () => window.history.back());

    const lightThemeButton = document.getElementById("light-theme-button");
    lightThemeButton?.addEventListener("click", () => {
      localStorage.setItem("theme", "light");
      toggleTheme(false);
    });

    const darkThemeButton = document.getElementById("dark-theme-button");
    darkThemeButton?.addEventListener("click", () => {
      localStorage.setItem("theme", "dark");
      toggleTheme(true);
    });

    const systemThemeButton = document.getElementById("system-theme-button");
    systemThemeButton?.addEventListener("click", () => {
      localStorage.setItem("theme", "system");
      toggleTheme(window.matchMedia("(prefers-color-scheme: dark)").matches);
    });

    window.matchMedia("(prefers-color-scheme: dark)")
      .addEventListener("change", event => {
        if (localStorage.theme === "system") {
          toggleTheme(event.matches);
        }
      }
    );

    document.addEventListener("scroll", onScroll);
  }

  function animate() {
    const animateElements = document.querySelectorAll(".animate");

    animateElements.forEach((element, index) => {
      setTimeout(() => {
        element.classList.add("show");
      }, index * 150);
    });
  }

  function onScroll() {
    if (window.scrollY > 0) {
      document.documentElement.classList.add("scrolled");
    } else {
      document.documentElement.classList.remove("scrolled");
    }
  }

  function scrollToTop(event) {
    event.preventDefault();
    window.scrollTo({
      top: 0,
      behavior: "smooth"
    });
  }

function toggleTheme(dark) {
    const css = document.createElement("style");

    css.appendChild(
      document.createTextNode(
        `* {
             -webkit-transition: none !important;
             -moz-transition: none !important;
             -o-transition: none !important;
             -ms-transition: none !important;
             transition: none !important;
          }
        `,
      )
    );

    document.head.appendChild(css);

    if (dark) {
      document.documentElement.classList.add("dark");
    } else {
      document.documentElement.classList.remove("dark");
    }

  window.getComputedStyle(css).opacity;
    document.head.removeChild(css);
  }

  function preloadTheme() {
    const userTheme = localStorage.theme;

    if (userTheme === "light" || userTheme === "dark") {
      toggleTheme(userTheme === "dark");
    } else {
      toggleTheme(window.matchMedia("(prefers-color-scheme: dark)").matches);
    }
  }

  document.addEventListener("DOMContentLoaded", () => init());
  document.addEventListener("astro:after-swap", () => init());
  preloadTheme();
</script><link rel="stylesheet" href="/_astro/_slug_.9cf2N-Ct.css"><script type="module" src="/_astro/hoisted.JmkTFhge.js"></script></head> <body> <header> <div class="mx-auto max-w-screen-sm px-5">  <div class="flex flex-wrap gap-y-2 justify-between"> <a href="/" target="_self" class="inline-block decoration-black/15 dark:decoration-white/30 hover:decoration-black/25 hover:dark:decoration-white/50 text-current hover:text-black hover:dark:text-white transition-colors duration-300 ease-in-out">  <div class="font-semibold"> @rustaceanrob </div>  </a> <nav class="flex gap-1"> <a href="/blog" target="_self" class="inline-block decoration-black/15 dark:decoration-white/30 hover:decoration-black/25 hover:dark:decoration-white/50 text-current hover:text-black hover:dark:text-white transition-colors duration-300 ease-in-out underline underline-offset-2"> 
blog
 </a> <span> / </span> <a href="/work" target="_self" class="inline-block decoration-black/15 dark:decoration-white/30 hover:decoration-black/25 hover:dark:decoration-white/50 text-current hover:text-black hover:dark:text-white transition-colors duration-300 ease-in-out underline underline-offset-2"> 
work
 </a> <!-- <span>
          {`/`}
        </span> --> <!-- <Link href="/projects">
          projects
        </Link> --> </nav> </div>  </div> </header> <main>  <div class="mx-auto max-w-screen-sm px-5">  <div class="animate"> <a href="/blog" class="relative group w-fit flex pl-7 pr-3 py-1.5 flex-nowrap rounded border border-black/15 dark:border-white/20 hover:bg-black/5 dark:hover:bg-white/5 hover:text-black dark:hover:text-white transition-colors duration-300 ease-in-out"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="absolute top-1/2 left-2 -translate-y-1/2 size-4 stroke-2 fill-none stroke-current"> <line x1="5" y1="12" x2="19" y2="12" class="translate-x-2 group-hover:translate-x-0 scale-x-0 group-hover:scale-x-100 transition-transform duration-300 ease-in-out"></line> <polyline points="12 5 5 12 12 19" class="translate-x-1 group-hover:translate-x-0 transition-transform duration-300 ease-in-out"></polyline> </svg> <div class="text-sm"> 
Back to blog
 </div> </a> </div> <div class="space-y-1 my-10"> <div class="animate flex items-center gap-1.5"> <div class="font-base text-sm"> <time datetime="2024-01-29T10:00:00.000Z"> Jan 29, 2024 </time> </div>
&bull;
<div class="font-base text-sm"> 12 min read </div> </div> <div class="animate text-2xl font-semibold text-black dark:text-white"> Bitcoin Transactions from 0 and 1 </div> </div> <article class="animate"> <h2 id="context">Context</h2>
<p>Some programmers adhere to the donâ€™t repeat yourself principle. I ignored that rule in every part of this assignment. In this code I construct some Bitcoin transactions from different sets of byte arrays. Some were signatures, others were hashes, all of them made me feel like I was in hell. The result of my code was a transaction that recorded my name in the Chaincode Signet blockchain. My name is sadly recorded as <strong>rOB</strong> instead of ROB in ASCII. You can find it <a href="https://mempool.btcfoss.bitherding.com/tx/6d2e62cc7db1a88178eb4eb777f1243a9bf67e19a0f30a9f4ba80dc91097ec6a#flow=&#x26;vout=0">here</a>. This was the week 2 exercise for the <strong>Chaincode: Start Your Career in FOSS</strong> program.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#E1E4E8">#![allow(unused)]</span></span>
<span class="line"><span style="color:#F97583">extern</span><span style="color:#F97583"> crate</span><span style="color:#E1E4E8"> balance;</span></span>
<span class="line"><span style="color:#F97583">extern</span><span style="color:#F97583"> crate</span><span style="color:#E1E4E8"> bitcoincore_rpc;</span></span>
<span class="line"><span style="color:#F97583">use</span><span style="color:#B392F0"> balance</span><span style="color:#F97583">::</span><span style="color:#E1E4E8">{</span><span style="color:#B392F0">OutgoingTx</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">WalletState</span><span style="color:#E1E4E8">};</span></span>
<span class="line"><span style="color:#F97583">use</span><span style="color:#B392F0"> bitcoincore_rpc</span><span style="color:#F97583">::</span><span style="color:#B392F0">bitcoin</span><span style="color:#F97583">::</span><span style="color:#E1E4E8">{locktime, sighash};</span></span>
<span class="line"><span style="color:#F97583">use</span><span style="color:#B392F0"> bitcoincore_rpc</span><span style="color:#F97583">::</span><span style="color:#E1E4E8">{</span><span style="color:#B392F0">Auth</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">Client</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">RpcApi</span><span style="color:#E1E4E8">};</span></span>
<span class="line"><span style="color:#F97583">use</span><span style="color:#E1E4E8"> bs58;</span></span>
<span class="line"><span style="color:#F97583">use</span><span style="color:#E1E4E8"> hex;</span></span>
<span class="line"><span style="color:#F97583">use</span><span style="color:#B392F0"> hmac_sha512</span><span style="color:#F97583">::</span><span style="color:#B392F0">HMAC</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">use</span><span style="color:#B392F0"> num_bigint</span><span style="color:#F97583">::</span><span style="color:#B392F0">BigUint</span><span style="color:#E1E4E8">; </span><span style="color:#F97583">use</span><span style="color:#B392F0"> ripemd</span><span style="color:#F97583">::</span><span style="color:#B392F0">digest</span><span style="color:#F97583">::</span><span style="color:#E1E4E8">{</span><span style="color:#B392F0">FixedOutput</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">Update</span><span style="color:#E1E4E8">};</span></span>
<span class="line"><span style="color:#F97583">use</span><span style="color:#B392F0"> ripemd</span><span style="color:#F97583">::</span><span style="color:#B392F0">digest</span><span style="color:#F97583">::</span><span style="color:#B392F0">crypto_common</span><span style="color:#F97583">::</span><span style="color:#B392F0">KeyInit</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#6A737D">// for modulus math on large numbers</span></span>
<span class="line"><span style="color:#F97583">use</span><span style="color:#B392F0"> ripemd</span><span style="color:#F97583">::</span><span style="color:#E1E4E8">{</span><span style="color:#B392F0">Ripemd160</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">Ripemd160Core</span><span style="color:#E1E4E8">};</span></span>
<span class="line"><span style="color:#F97583">use</span><span style="color:#B392F0"> secp256k1</span><span style="color:#F97583">::</span><span style="color:#B392F0">hashes</span><span style="color:#F97583">::</span><span style="color:#E1E4E8">sha256;</span></span>
<span class="line"><span style="color:#F97583">use</span><span style="color:#B392F0"> secp256k1</span><span style="color:#F97583">::</span><span style="color:#E1E4E8">{</span><span style="color:#B392F0">Secp256k1</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">SecretKey</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">PublicKey</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">Message</span><span style="color:#E1E4E8">};</span></span>
<span class="line"><span style="color:#F97583">use</span><span style="color:#B392F0"> sha2</span><span style="color:#F97583">::</span><span style="color:#E1E4E8">{</span><span style="color:#B392F0">Sha256</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">Digest</span><span style="color:#E1E4E8">};</span></span>
<span class="line"><span style="color:#F97583">use</span><span style="color:#B392F0"> std</span><span style="color:#F97583">::</span><span style="color:#B392F0">borrow</span><span style="color:#F97583">::</span><span style="color:#B392F0">Borrow</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">use</span><span style="color:#B392F0"> std</span><span style="color:#F97583">::</span><span style="color:#B392F0">error</span><span style="color:#F97583">::</span><span style="color:#B392F0">Error</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">use</span><span style="color:#B392F0"> std</span><span style="color:#F97583">::</span><span style="color:#B392F0">hash</span><span style="color:#F97583">::</span><span style="color:#B392F0">Hash</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">use</span><span style="color:#B392F0"> std</span><span style="color:#F97583">::</span><span style="color:#B392F0">io</span><span style="color:#F97583">::</span><span style="color:#E1E4E8">{</span><span style="color:#B392F0">Read</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">Write</span><span style="color:#E1E4E8">};</span></span>
<span class="line"><span style="color:#F97583">use</span><span style="color:#B392F0"> std</span><span style="color:#F97583">::</span><span style="color:#B392F0">ops</span><span style="color:#F97583">::</span><span style="color:#B392F0">Add</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">use</span><span style="color:#B392F0"> std</span><span style="color:#F97583">::</span><span style="color:#B392F0">path</span><span style="color:#F97583">::</span><span style="color:#B392F0">PathBuf</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">use</span><span style="color:#B392F0"> std</span><span style="color:#F97583">::</span><span style="color:#B392F0">str</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">#[derive(</span><span style="color:#B392F0">Debug</span><span style="color:#E1E4E8">)]</span></span>
<span class="line"><span style="color:#F97583">pub</span><span style="color:#F97583"> enum</span><span style="color:#B392F0"> SpendError</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">    MissingCodeCantRun</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#6A737D">    // Add more relevant error variants</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">pub</span><span style="color:#F97583"> struct</span><span style="color:#B392F0"> Utxo</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">    script_pubkey</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Vec</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">>,</span></span>
<span class="line"><span style="color:#E1E4E8">    amount</span><span style="color:#F97583">:</span><span style="color:#B392F0"> u32</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">pub</span><span style="color:#F97583"> struct</span><span style="color:#B392F0"> Outpoint</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">    txid</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> [</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">; </span><span style="color:#79B8FF">32</span><span style="color:#E1E4E8">],</span></span>
<span class="line"><span style="color:#E1E4E8">    index</span><span style="color:#F97583">:</span><span style="color:#B392F0"> u32</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// Given 2 compressed public keys as byte arrays, construct</span></span>
<span class="line"><span style="color:#6A737D">// a 2-of-2 multisig output script. No length byte prefix is necessary.</span></span>
<span class="line"><span style="color:#F97583">fn</span><span style="color:#B392F0"> create_multisig_script</span><span style="color:#E1E4E8">(keys</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Vec</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">Vec</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">>>) </span><span style="color:#F97583">-></span><span style="color:#B392F0"> Vec</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> pk1 </span><span style="color:#F97583">=</span><span style="color:#F97583"> &#x26;</span><span style="color:#E1E4E8">keys[</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">];</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> pk2 </span><span style="color:#F97583">=</span><span style="color:#F97583"> &#x26;</span><span style="color:#E1E4E8">keys[</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">];</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#F97583"> mut</span><span style="color:#E1E4E8"> script</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Vec</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">> </span><span style="color:#F97583">=</span><span style="color:#B392F0"> vec!</span><span style="color:#E1E4E8">[];</span></span>
<span class="line"><span style="color:#E1E4E8">    script</span><span style="color:#F97583">.</span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">0x52</span><span style="color:#E1E4E8">); </span><span style="color:#6A737D">// PUSH 2</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> pk_1_size </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> pk1</span><span style="color:#F97583">.</span><span style="color:#B392F0">len</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">as</span><span style="color:#B392F0"> u8</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">    script</span><span style="color:#F97583">.</span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">(pk_1_size);</span></span>
<span class="line"><span style="color:#E1E4E8">    script</span><span style="color:#F97583">.</span><span style="color:#B392F0">extend</span><span style="color:#E1E4E8">(pk1</span><span style="color:#F97583">.</span><span style="color:#B392F0">iter</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> pk_2_size </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> pk2</span><span style="color:#F97583">.</span><span style="color:#B392F0">len</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">as</span><span style="color:#B392F0"> u8</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">    script</span><span style="color:#F97583">.</span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">(pk_2_size);</span></span>
<span class="line"><span style="color:#E1E4E8">    script</span><span style="color:#F97583">.</span><span style="color:#B392F0">extend</span><span style="color:#E1E4E8">(pk2</span><span style="color:#F97583">.</span><span style="color:#B392F0">iter</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#E1E4E8">    script</span><span style="color:#F97583">.</span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">0x52</span><span style="color:#E1E4E8">); </span><span style="color:#6A737D">// PUSH 2</span></span>
<span class="line"><span style="color:#E1E4E8">    script</span><span style="color:#F97583">.</span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">0xae</span><span style="color:#E1E4E8">); </span><span style="color:#6A737D">// check multisig</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> script;</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// Given an output script as a byte array, compute the p2wsh witness program</span></span>
<span class="line"><span style="color:#6A737D">// This is a segwit version 0 pay-to-script-hash witness program.</span></span>
<span class="line"><span style="color:#6A737D">// https://github.com/bitcoin/bips/blob/master/bip-0141.mediawiki#p2wsh</span></span>
<span class="line"><span style="color:#F97583">fn</span><span style="color:#B392F0"> get_p2wsh_program</span><span style="color:#E1E4E8">(script</span><span style="color:#F97583">:</span><span style="color:#F97583"> &#x26;</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">], version</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Option</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">u32</span><span style="color:#E1E4E8">>) </span><span style="color:#F97583">-></span><span style="color:#B392F0"> Vec</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> script_hash </span><span style="color:#F97583">=</span><span style="color:#B392F0"> single_hash</span><span style="color:#E1E4E8">(script</span><span style="color:#F97583">.</span><span style="color:#B392F0">to_vec</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#F97583"> let</span><span style="color:#B392F0"> Some</span><span style="color:#E1E4E8">(version) </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> version {</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#F97583"> mut</span><span style="color:#E1E4E8"> p2wsh</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Vec</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">> </span><span style="color:#F97583">=</span><span style="color:#B392F0"> vec!</span><span style="color:#E1E4E8">[version</span><span style="color:#F97583">.</span><span style="color:#B392F0">try_into</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">.</span><span style="color:#B392F0">unwrap</span><span style="color:#E1E4E8">(), </span><span style="color:#79B8FF">0x20</span><span style="color:#E1E4E8">];</span></span>
<span class="line"><span style="color:#E1E4E8">        p2wsh</span><span style="color:#F97583">.</span><span style="color:#B392F0">extend</span><span style="color:#E1E4E8">(script_hash</span><span style="color:#F97583">.</span><span style="color:#B392F0">iter</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#E1E4E8"> p2wsh</span></span>
<span class="line"><span style="color:#E1E4E8">    } </span><span style="color:#F97583">else</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#F97583"> mut</span><span style="color:#E1E4E8"> p2wsh </span><span style="color:#F97583">=</span><span style="color:#B392F0"> vec!</span><span style="color:#E1E4E8">[</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">0x20</span><span style="color:#E1E4E8">];</span></span>
<span class="line"><span style="color:#E1E4E8">        p2wsh</span><span style="color:#F97583">.</span><span style="color:#B392F0">extend</span><span style="color:#E1E4E8">(script_hash</span><span style="color:#F97583">.</span><span style="color:#B392F0">iter</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#E1E4E8"> p2wsh</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// Given an outpoint, return a serialized transaction input spending it</span></span>
<span class="line"><span style="color:#6A737D">// Use hard-coded defaults for sequence and scriptSig</span></span>
<span class="line"><span style="color:#F97583">fn</span><span style="color:#B392F0"> input_from_utxo</span><span style="color:#E1E4E8">(txid</span><span style="color:#F97583">:</span><span style="color:#F97583"> &#x26;</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">], index</span><span style="color:#F97583">:</span><span style="color:#B392F0"> u32</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-></span><span style="color:#B392F0"> Vec</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#F97583"> mut</span><span style="color:#E1E4E8"> input</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Vec</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">> </span><span style="color:#F97583">=</span><span style="color:#B392F0"> vec!</span><span style="color:#E1E4E8">[];</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> position </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> index</span><span style="color:#F97583">.</span><span style="color:#B392F0">to_le_bytes</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">    input</span><span style="color:#F97583">.</span><span style="color:#B392F0">extend</span><span style="color:#E1E4E8">(txid</span><span style="color:#F97583">.</span><span style="color:#B392F0">iter</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#E1E4E8">    input</span><span style="color:#F97583">.</span><span style="color:#B392F0">extend</span><span style="color:#E1E4E8">(position</span><span style="color:#F97583">.</span><span style="color:#B392F0">iter</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#E1E4E8">    input</span><span style="color:#F97583">.</span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">0x00</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> seq </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 0xffffffff</span><span style="color:#B392F0">u32</span><span style="color:#F97583">.</span><span style="color:#B392F0">to_be_bytes</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">    input</span><span style="color:#F97583">.</span><span style="color:#B392F0">extend</span><span style="color:#E1E4E8">(seq</span><span style="color:#F97583">.</span><span style="color:#B392F0">iter</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#6A737D">    // println!("Transaciton Input: {:?}", hex::encode(input.clone()));</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> input</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// Given an output script and value (in satoshis), return a serialized transaction output</span></span>
<span class="line"><span style="color:#F97583">fn</span><span style="color:#B392F0"> output_from_options</span><span style="color:#E1E4E8">(script</span><span style="color:#F97583">:</span><span style="color:#F97583"> &#x26;</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">], value</span><span style="color:#F97583">:</span><span style="color:#B392F0"> u32</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-></span><span style="color:#B392F0"> Vec</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#F97583"> mut</span><span style="color:#E1E4E8"> ser_output</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Vec</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">> </span><span style="color:#F97583">=</span><span style="color:#B392F0"> vec!</span><span style="color:#E1E4E8">[];</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> sats </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> value</span><span style="color:#F97583">.</span><span style="color:#B392F0">to_le_bytes</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> pad </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 0</span><span style="color:#B392F0">u32</span><span style="color:#F97583">.</span><span style="color:#B392F0">to_be_bytes</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> l </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> script</span><span style="color:#F97583">.</span><span style="color:#B392F0">len</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">as</span><span style="color:#B392F0"> u8</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">    ser_output</span><span style="color:#F97583">.</span><span style="color:#B392F0">extend</span><span style="color:#E1E4E8">(sats</span><span style="color:#F97583">.</span><span style="color:#B392F0">iter</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#E1E4E8">    ser_output</span><span style="color:#F97583">.</span><span style="color:#B392F0">extend</span><span style="color:#E1E4E8">(pad</span><span style="color:#F97583">.</span><span style="color:#B392F0">iter</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#E1E4E8">    ser_output</span><span style="color:#F97583">.</span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">(l);</span></span>
<span class="line"><span style="color:#E1E4E8">    ser_output</span><span style="color:#F97583">.</span><span style="color:#B392F0">extend</span><span style="color:#E1E4E8">(script</span><span style="color:#F97583">.</span><span style="color:#B392F0">iter</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#6A737D">    // println!("Output: {:?}", hex::encode(ser_output.clone()));</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> ser_output</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// Given a Utxo object, extract the public key hash from the output script</span></span>
<span class="line"><span style="color:#6A737D">// and assemble the p2wpkh scriptcode as defined in BIP143</span></span>
<span class="line"><span style="color:#6A737D">// &#x3C;script length> OP_DUP OP_HASH160 &#x3C;pubkey hash> OP_EQUALVERIFY OP_CHECKSIG</span></span>
<span class="line"><span style="color:#6A737D">// https://github.com/bitcoin/bips/blob/master/bip-0143.mediawiki#specification</span></span>
<span class="line"><span style="color:#F97583">fn</span><span style="color:#B392F0"> get_p2wpkh_scriptcode</span><span style="color:#E1E4E8">(utxo</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Utxo</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-></span><span style="color:#B392F0"> Vec</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#F97583"> mut</span><span style="color:#E1E4E8"> script_code</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Vec</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">> </span><span style="color:#F97583">=</span><span style="color:#B392F0"> vec!</span><span style="color:#E1E4E8">[];</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> first_half</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> [</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">; </span><span style="color:#79B8FF">4</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 0x1976a914</span><span style="color:#B392F0">u32</span><span style="color:#F97583">.</span><span style="color:#B392F0">to_be_bytes</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">    script_code</span><span style="color:#F97583">.</span><span style="color:#B392F0">extend</span><span style="color:#E1E4E8">(first_half</span><span style="color:#F97583">.</span><span style="color:#B392F0">iter</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#6A737D">    // println!("Script Code Prefix {:?}", hex::encode(first_half.clone()));</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> pkh </span><span style="color:#F97583">=</span><span style="color:#F97583"> &#x26;</span><span style="color:#E1E4E8">utxo</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">script_pubkey[</span><span style="color:#79B8FF">2</span><span style="color:#F97583">..</span><span style="color:#E1E4E8">];</span></span>
<span class="line"><span style="color:#6A737D">    // println!("Public Key Hash in Script Code: {:?}", hex::encode(pkh.clone()));</span></span>
<span class="line"><span style="color:#E1E4E8">    script_code</span><span style="color:#F97583">.</span><span style="color:#B392F0">extend</span><span style="color:#E1E4E8">(pkh</span><span style="color:#F97583">.</span><span style="color:#B392F0">iter</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#E1E4E8">    script_code</span><span style="color:#F97583">.</span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">0x88</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    script_code</span><span style="color:#F97583">.</span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">0xac</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> script_code</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// Compute the commitment hash for a single input and return bytes to sign.</span></span>
<span class="line"><span style="color:#6A737D">// This implements the BIP 143 transaction digest algorithm</span></span>
<span class="line"><span style="color:#6A737D">// https://github.com/bitcoin/bips/blob/master/bip-0143.mediawiki#specification</span></span>
<span class="line"><span style="color:#6A737D">// We assume only a single input and two outputs,</span></span>
<span class="line"><span style="color:#6A737D">// as well as constant default values for sequence and locktime</span></span>
<span class="line"><span style="color:#F97583">fn</span><span style="color:#B392F0"> get_commitment_hash</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#E1E4E8">    outpoint</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Outpoint</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    scriptcode</span><span style="color:#F97583">:</span><span style="color:#F97583"> &#x26;</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">],</span></span>
<span class="line"><span style="color:#E1E4E8">    value</span><span style="color:#F97583">:</span><span style="color:#B392F0"> u32</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    outputs</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Vec</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">Utxo</span><span style="color:#E1E4E8">>,</span></span>
<span class="line"><span style="color:#E1E4E8">) </span><span style="color:#F97583">-></span><span style="color:#B392F0"> Vec</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#F97583"> mut</span><span style="color:#E1E4E8"> commitment</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Vec</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">> </span><span style="color:#F97583">=</span><span style="color:#B392F0"> vec!</span><span style="color:#E1E4E8">[];</span></span>
<span class="line"><span style="color:#6A737D">    // println!("\n==========================\n");</span></span>
<span class="line"><span style="color:#6A737D">    // Version</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> version </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 2</span><span style="color:#B392F0">u32</span><span style="color:#F97583">.</span><span style="color:#B392F0">to_le_bytes</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">    commitment</span><span style="color:#F97583">.</span><span style="color:#B392F0">extend</span><span style="color:#E1E4E8">(version</span><span style="color:#F97583">.</span><span style="color:#B392F0">iter</span><span style="color:#E1E4E8">()); </span><span style="color:#6A737D">//1</span></span>
<span class="line"><span style="color:#6A737D">    // println!("Version: {:?}", hex::encode(version));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // All TX input outpoints (only one in our case)</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#F97583"> mut</span><span style="color:#E1E4E8"> input_preimage </span><span style="color:#F97583">=</span><span style="color:#B392F0"> vec!</span><span style="color:#E1E4E8">[]; </span></span>
<span class="line"><span style="color:#E1E4E8">    input_preimage</span><span style="color:#F97583">.</span><span style="color:#B392F0">extend</span><span style="color:#E1E4E8">(outpoint</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">txid); </span></span>
<span class="line"><span style="color:#E1E4E8">    input_preimage</span><span style="color:#F97583">.</span><span style="color:#B392F0">extend</span><span style="color:#E1E4E8">(outpoint</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">index</span><span style="color:#F97583">.</span><span style="color:#B392F0">to_le_bytes</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> hash_prevouts </span><span style="color:#F97583">=</span><span style="color:#B392F0"> double_hash</span><span style="color:#E1E4E8">(input_preimage</span><span style="color:#F97583">.</span><span style="color:#B392F0">clone</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#E1E4E8">    commitment</span><span style="color:#F97583">.</span><span style="color:#B392F0">extend</span><span style="color:#E1E4E8">(hash_prevouts</span><span style="color:#F97583">.</span><span style="color:#B392F0">iter</span><span style="color:#E1E4E8">()); </span><span style="color:#6A737D">//2</span></span>
<span class="line"><span style="color:#6A737D">    // println!("Hash Prevouts: {:?}", hex::encode(hash_prevouts));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // All TX input sequences (only one for us, always default value)</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> ser_input_seq </span><span style="color:#F97583">=</span><span style="color:#B392F0"> double_hash</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">0xffffffff</span><span style="color:#B392F0">u32</span><span style="color:#F97583">.</span><span style="color:#B392F0">to_be_bytes</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">.</span><span style="color:#B392F0">to_vec</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#E1E4E8">    commitment</span><span style="color:#F97583">.</span><span style="color:#B392F0">extend</span><span style="color:#E1E4E8">(ser_input_seq</span><span style="color:#F97583">.</span><span style="color:#B392F0">iter</span><span style="color:#E1E4E8">()); </span><span style="color:#6A737D">//3</span></span>
<span class="line"><span style="color:#6A737D">    // println!("Hash Sequence: {:?}", hex::encode(ser_input_seq));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // Single outpoint being spent</span></span>
<span class="line"><span style="color:#E1E4E8">    commitment</span><span style="color:#F97583">.</span><span style="color:#B392F0">extend</span><span style="color:#E1E4E8">(input_preimage</span><span style="color:#F97583">.</span><span style="color:#B392F0">iter</span><span style="color:#E1E4E8">()); </span><span style="color:#6A737D">// 4</span></span>
<span class="line"><span style="color:#6A737D">    // println!("Outpoint: {:?}", hex::encode(input_preimage));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // Scriptcode (the scriptPubKey in/implied by the output being spent, see BIP 143)</span></span>
<span class="line"><span style="color:#E1E4E8">    commitment</span><span style="color:#F97583">.</span><span style="color:#B392F0">extend</span><span style="color:#E1E4E8">(scriptcode</span><span style="color:#F97583">.</span><span style="color:#B392F0">iter</span><span style="color:#E1E4E8">()); </span><span style="color:#6A737D">//5</span></span>
<span class="line"><span style="color:#6A737D">    // println!("Script code: {:?}", hex::encode(scriptcode));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // Value of output being spent</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> amount </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> value</span><span style="color:#F97583">.</span><span style="color:#B392F0">to_le_bytes</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> pad </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 0</span><span style="color:#B392F0">u32</span><span style="color:#F97583">.</span><span style="color:#B392F0">to_be_bytes</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">    commitment</span><span style="color:#F97583">.</span><span style="color:#B392F0">extend</span><span style="color:#E1E4E8">(amount</span><span style="color:#F97583">.</span><span style="color:#B392F0">iter</span><span style="color:#E1E4E8">()); </span><span style="color:#6A737D">//6</span></span>
<span class="line"><span style="color:#E1E4E8">    commitment</span><span style="color:#F97583">.</span><span style="color:#B392F0">extend</span><span style="color:#E1E4E8">(pad</span><span style="color:#F97583">.</span><span style="color:#B392F0">iter</span><span style="color:#E1E4E8">()); </span></span>
<span class="line"><span style="color:#6A737D">    // print!("Value: {:?}", hex::encode(amount));</span></span>
<span class="line"><span style="color:#6A737D">    // println!("{:?}",  hex::encode(pad));</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // Sequence of output being spent (always default for us)</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> n_seq </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 0xffffffff</span><span style="color:#B392F0">u32</span><span style="color:#F97583">.</span><span style="color:#B392F0">to_be_bytes</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">    commitment</span><span style="color:#F97583">.</span><span style="color:#B392F0">extend</span><span style="color:#E1E4E8">(n_seq</span><span style="color:#F97583">.</span><span style="color:#B392F0">iter</span><span style="color:#E1E4E8">()); </span><span style="color:#6A737D">//7</span></span>
<span class="line"><span style="color:#6A737D">    // println!("nSequence: {:?}", hex::encode(n_seq));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // All TX outputs</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#F97583"> mut</span><span style="color:#E1E4E8"> output_preimage</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Vec</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">> </span><span style="color:#F97583">=</span><span style="color:#B392F0"> vec!</span><span style="color:#E1E4E8">[];</span></span>
<span class="line"><span style="color:#F97583">    for</span><span style="color:#E1E4E8"> output </span><span style="color:#F97583">in</span><span style="color:#E1E4E8"> outputs {</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#E1E4E8"> amount </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> output</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">amount</span><span style="color:#F97583">.</span><span style="color:#B392F0">to_le_bytes</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#E1E4E8"> pad </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 0</span><span style="color:#B392F0">u32</span><span style="color:#F97583">.</span><span style="color:#B392F0">to_be_bytes</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">        output_preimage</span><span style="color:#F97583">.</span><span style="color:#B392F0">extend</span><span style="color:#E1E4E8">(amount</span><span style="color:#F97583">.</span><span style="color:#B392F0">iter</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#E1E4E8">        output_preimage</span><span style="color:#F97583">.</span><span style="color:#B392F0">extend</span><span style="color:#E1E4E8">(pad</span><span style="color:#F97583">.</span><span style="color:#B392F0">iter</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#E1E4E8"> output_script_len </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> output</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">script_pubkey</span><span style="color:#F97583">.</span><span style="color:#B392F0">len</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">as</span><span style="color:#B392F0"> u8</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">        output_preimage</span><span style="color:#F97583">.</span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">(output_script_len);</span></span>
<span class="line"><span style="color:#E1E4E8">        output_preimage</span><span style="color:#F97583">.</span><span style="color:#B392F0">extend</span><span style="color:#E1E4E8">(output</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">script_pubkey</span><span style="color:#F97583">.</span><span style="color:#B392F0">iter</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#6A737D">    // println!("Output Preimage (???): {:?}", hex::encode(output_preimage.clone()));</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> output_hash </span><span style="color:#F97583">=</span><span style="color:#B392F0"> double_hash</span><span style="color:#E1E4E8">(output_preimage);</span></span>
<span class="line"><span style="color:#E1E4E8">    commitment</span><span style="color:#F97583">.</span><span style="color:#B392F0">extend</span><span style="color:#E1E4E8">(output_hash</span><span style="color:#F97583">.</span><span style="color:#B392F0">iter</span><span style="color:#E1E4E8">()); </span><span style="color:#6A737D">//8</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // Locktime (always default for us)</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> locktime </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 0x00000000</span><span style="color:#B392F0">u32</span><span style="color:#F97583">.</span><span style="color:#B392F0">to_be_bytes</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">    commitment</span><span style="color:#F97583">.</span><span style="color:#B392F0">extend</span><span style="color:#E1E4E8">(locktime</span><span style="color:#F97583">.</span><span style="color:#B392F0">iter</span><span style="color:#E1E4E8">()); </span><span style="color:#6A737D">//9</span></span>
<span class="line"><span style="color:#6A737D">    // println!("Locktime: {:?}", hex::encode(locktime));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // SIGHASH_ALL (always default for us)</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> sighash </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 1</span><span style="color:#B392F0">u32</span><span style="color:#F97583">.</span><span style="color:#B392F0">to_le_bytes</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">    commitment</span><span style="color:#F97583">.</span><span style="color:#B392F0">extend</span><span style="color:#E1E4E8">(sighash</span><span style="color:#F97583">.</span><span style="color:#B392F0">iter</span><span style="color:#E1E4E8">()); </span><span style="color:#6A737D">//10</span></span>
<span class="line"><span style="color:#6A737D">    // println!("Sighash: {:?}", hex::encode(sighash));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // println!("\nCommitment: {:?}", hex::encode(commitment.clone()));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> d256 </span><span style="color:#F97583">=</span><span style="color:#B392F0"> double_hash</span><span style="color:#E1E4E8">(commitment);</span></span>
<span class="line"><span style="color:#6A737D">    // println!("\nHash256: {:}\n", hex::encode(d256.clone()));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> d256</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// Given a JSON utxo object and a list of all of our wallet's witness programs,</span></span>
<span class="line"><span style="color:#6A737D">// return the index of the derived key that can spend the coin.</span></span>
<span class="line"><span style="color:#6A737D">// This index should match the corresponding private key in our wallet's list.</span></span>
<span class="line"><span style="color:#F97583">fn</span><span style="color:#B392F0"> get_key_index</span><span style="color:#E1E4E8">(utxo</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Utxo</span><span style="color:#E1E4E8">, programs</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Vec</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#F97583">&#x26;</span><span style="color:#B392F0">str</span><span style="color:#E1E4E8">>) </span><span style="color:#F97583">-></span><span style="color:#B392F0"> u32</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    for</span><span style="color:#E1E4E8"> (index, program) </span><span style="color:#F97583">in</span><span style="color:#E1E4E8"> programs</span><span style="color:#F97583">.</span><span style="color:#B392F0">iter</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">.</span><span style="color:#B392F0">enumerate</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#B392F0"> hex</span><span style="color:#F97583">::</span><span style="color:#B392F0">decode</span><span style="color:#E1E4E8">(program)</span><span style="color:#F97583">.</span><span style="color:#B392F0">expect</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Could not decode program"</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">.</span><span style="color:#B392F0">eq</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">utxo</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">script_pubkey) {</span></span>
<span class="line"><span style="color:#F97583">            return</span><span style="color:#E1E4E8"> index </span><span style="color:#F97583">as</span><span style="color:#B392F0"> u32</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#79B8FF"> 0</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// Given a private key and message digest as bytes, compute the ECDSA signature.</span></span>
<span class="line"><span style="color:#6A737D">// Bitcoin signatures:</span></span>
<span class="line"><span style="color:#6A737D">// - Must be strict-DER encoded</span></span>
<span class="line"><span style="color:#6A737D">// - Must have the SIGHASH_ALL byte (0x01) appended</span></span>
<span class="line"><span style="color:#6A737D">// - Must have a low s value as defined by BIP 62:</span></span>
<span class="line"><span style="color:#6A737D">//   https://github.com/bitcoin/bips/blob/master/bip-0062.mediawiki#user-content-Low_S_values_in_signatures</span></span>
<span class="line"><span style="color:#F97583">fn</span><span style="color:#B392F0"> sign</span><span style="color:#E1E4E8">(privkey</span><span style="color:#F97583">:</span><span style="color:#F97583"> &#x26;</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">; </span><span style="color:#79B8FF">32</span><span style="color:#E1E4E8">], msg</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Vec</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">>) </span><span style="color:#F97583">-></span><span style="color:#B392F0"> Vec</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#6A737D">    // Keep signing until we produce a signature with "low s value"</span></span>
<span class="line"><span style="color:#6A737D">    // We will have to decode the DER-encoded signature and extract the s value to check it</span></span>
<span class="line"><span style="color:#6A737D">    // Format: 0x30 [total-length] 0x02 [R-length] [R] 0x02 [S-length] [S] [sighash]</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> secp </span><span style="color:#F97583">=</span><span style="color:#B392F0"> Secp256k1</span><span style="color:#F97583">::</span><span style="color:#B392F0">new</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> k </span><span style="color:#F97583">=</span><span style="color:#B392F0"> SecretKey</span><span style="color:#F97583">::</span><span style="color:#B392F0">from_slice</span><span style="color:#E1E4E8">(privkey)</span><span style="color:#F97583">.</span><span style="color:#B392F0">expect</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Could not conform to SecretKey"</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> message </span><span style="color:#F97583">=</span><span style="color:#B392F0"> Message</span><span style="color:#F97583">::</span><span style="color:#B392F0">from_digest_slice</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">msg)</span><span style="color:#F97583">.</span><span style="color:#B392F0">expect</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Could not produce Message"</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#F97583"> mut</span><span style="color:#E1E4E8"> sig </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> secp</span><span style="color:#F97583">.</span><span style="color:#B392F0">sign_ecdsa</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">message, </span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">k);</span></span>
<span class="line"><span style="color:#E1E4E8">    sig</span><span style="color:#F97583">.</span><span style="color:#B392F0">normalize_s</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> der </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> sig</span><span style="color:#F97583">.</span><span style="color:#B392F0">serialize_der</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#F97583"> mut</span><span style="color:#E1E4E8"> strict_der_sig</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Vec</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">> </span><span style="color:#F97583">=</span><span style="color:#B392F0"> vec!</span><span style="color:#E1E4E8">[];</span></span>
<span class="line"><span style="color:#E1E4E8">    strict_der_sig</span><span style="color:#F97583">.</span><span style="color:#B392F0">extend</span><span style="color:#E1E4E8">(der</span><span style="color:#F97583">.</span><span style="color:#B392F0">to_vec</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">.</span><span style="color:#B392F0">iter</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#E1E4E8">    strict_der_sig</span><span style="color:#F97583">.</span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">0x01</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> strict_der_sig</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// Given a private key and transaction commitment hash to sign,</span></span>
<span class="line"><span style="color:#6A737D">// compute the signature and assemble the serialized p2pkh witness</span></span>
<span class="line"><span style="color:#6A737D">// as defined in BIP 141 (2 stack items: signature, compressed public key)</span></span>
<span class="line"><span style="color:#6A737D">// https://github.com/bitcoin/bips/blob/master/bip-0141.mediawiki#specification</span></span>
<span class="line"><span style="color:#F97583">fn</span><span style="color:#B392F0"> get_p2wpkh_witness</span><span style="color:#E1E4E8">(privkey</span><span style="color:#F97583">:</span><span style="color:#F97583"> &#x26;</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">; </span><span style="color:#79B8FF">32</span><span style="color:#E1E4E8">], msg</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Vec</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">>) </span><span style="color:#F97583">-></span><span style="color:#B392F0"> Vec</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#F97583"> mut</span><span style="color:#E1E4E8"> witness</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Vec</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">> </span><span style="color:#F97583">=</span><span style="color:#B392F0"> vec!</span><span style="color:#E1E4E8">[];</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> sig </span><span style="color:#F97583">=</span><span style="color:#B392F0"> sign</span><span style="color:#E1E4E8">(privkey, msg);</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> sig_size </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> sig</span><span style="color:#F97583">.</span><span style="color:#B392F0">len</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">as</span><span style="color:#B392F0"> u8</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#6A737D">    // println!("Signature Size: {:?}", hex::encode([sig_size]));</span></span>
<span class="line"><span style="color:#E1E4E8">    witness</span><span style="color:#F97583">.</span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">(sig_size);</span></span>
<span class="line"><span style="color:#6A737D">    // println!("Signature: {:?}", hex::encode(sig.clone()));</span></span>
<span class="line"><span style="color:#E1E4E8">    witness</span><span style="color:#F97583">.</span><span style="color:#B392F0">extend</span><span style="color:#E1E4E8">(sig</span><span style="color:#F97583">.</span><span style="color:#B392F0">iter</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> pk </span><span style="color:#F97583">=</span><span style="color:#B392F0"> balance</span><span style="color:#F97583">::</span><span style="color:#B392F0">derive_public_key_from_private</span><span style="color:#E1E4E8">(privkey);</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> pub_key_size </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> pk</span><span style="color:#F97583">.</span><span style="color:#B392F0">len</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">as</span><span style="color:#B392F0"> u8</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#6A737D">    // println!("Public Key Size: {:?}", hex::encode([pub_key_size]));</span></span>
<span class="line"><span style="color:#E1E4E8">    witness</span><span style="color:#F97583">.</span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">(pub_key_size);</span></span>
<span class="line"><span style="color:#6A737D">    // println!("Witness Public Key: {:?}", hex::encode(pk.clone()));</span></span>
<span class="line"><span style="color:#E1E4E8">    witness</span><span style="color:#F97583">.</span><span style="color:#B392F0">extend</span><span style="color:#E1E4E8">(pk</span><span style="color:#F97583">.</span><span style="color:#B392F0">iter</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> witness</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// Given two private keys and a transaction commitment hash to sign,</span></span>
<span class="line"><span style="color:#6A737D">// compute both signatures and assemble the serialized p2pkh witness</span></span>
<span class="line"><span style="color:#6A737D">// as defined in BIP 141</span></span>
<span class="line"><span style="color:#6A737D">// Remember to add a 0x00 byte as the first witness element for CHECKMULTISIG bug</span></span>
<span class="line"><span style="color:#6A737D">// https://github.com/bitcoin/bips/blob/master/bip-0147.mediawiki</span></span>
<span class="line"><span style="color:#F97583">fn</span><span style="color:#B392F0"> get_p2wsh_witness</span><span style="color:#E1E4E8">(privs</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Vec</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">; 32]>, msg</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Vec</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">>) </span><span style="color:#F97583">-></span><span style="color:#B392F0"> Vec</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#6A737D">    //probably wrong</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#F97583"> mut</span><span style="color:#E1E4E8"> witness</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Vec</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">> </span><span style="color:#F97583">=</span><span style="color:#B392F0"> vec!</span><span style="color:#E1E4E8">[];</span></span>
<span class="line"><span style="color:#6A737D">    // witness.push(0x01);</span></span>
<span class="line"><span style="color:#E1E4E8">    witness</span><span style="color:#F97583">.</span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">0x00</span><span style="color:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> sig_1 </span><span style="color:#F97583">=</span><span style="color:#B392F0"> sign</span><span style="color:#E1E4E8">(privs[</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">], msg</span><span style="color:#F97583">.</span><span style="color:#B392F0">clone</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> sig_1_len </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> sig_1</span><span style="color:#F97583">.</span><span style="color:#B392F0">len</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">as</span><span style="color:#B392F0"> u8</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">    witness</span><span style="color:#F97583">.</span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">(sig_1_len);</span></span>
<span class="line"><span style="color:#E1E4E8">    witness</span><span style="color:#F97583">.</span><span style="color:#B392F0">extend</span><span style="color:#E1E4E8">(sig_1</span><span style="color:#F97583">.</span><span style="color:#B392F0">iter</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> pk_1 </span><span style="color:#F97583">=</span><span style="color:#B392F0"> balance</span><span style="color:#F97583">::</span><span style="color:#B392F0">derive_public_key_from_private</span><span style="color:#E1E4E8">(privs[</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">]);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> sig_2 </span><span style="color:#F97583">=</span><span style="color:#B392F0"> sign</span><span style="color:#E1E4E8">(privs[</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">], msg</span><span style="color:#F97583">.</span><span style="color:#B392F0">clone</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> sig_2_len </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> sig_2</span><span style="color:#F97583">.</span><span style="color:#B392F0">len</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">as</span><span style="color:#B392F0"> u8</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">    witness</span><span style="color:#F97583">.</span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">(sig_2_len);</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> pk_2 </span><span style="color:#F97583">=</span><span style="color:#B392F0"> balance</span><span style="color:#F97583">::</span><span style="color:#B392F0">derive_public_key_from_private</span><span style="color:#E1E4E8">(privs[</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">]);</span></span>
<span class="line"><span style="color:#E1E4E8">    witness</span><span style="color:#F97583">.</span><span style="color:#B392F0">extend</span><span style="color:#E1E4E8">(sig_2</span><span style="color:#F97583">.</span><span style="color:#B392F0">iter</span><span style="color:#E1E4E8">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> remaining_script </span><span style="color:#F97583">=</span><span style="color:#B392F0"> create_multisig_script</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">vec!</span><span style="color:#E1E4E8">[pk_1</span><span style="color:#F97583">.</span><span style="color:#B392F0">to_vec</span><span style="color:#E1E4E8">(), pk_2</span><span style="color:#F97583">.</span><span style="color:#B392F0">to_vec</span><span style="color:#E1E4E8">()]);</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> raw_script_len </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> remaining_script</span><span style="color:#F97583">.</span><span style="color:#B392F0">len</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">as</span><span style="color:#B392F0"> u8</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">    witness</span><span style="color:#F97583">.</span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">(raw_script_len);</span></span>
<span class="line"><span style="color:#E1E4E8">    witness</span><span style="color:#F97583">.</span><span style="color:#B392F0">extend</span><span style="color:#E1E4E8">(remaining_script</span><span style="color:#F97583">.</span><span style="color:#B392F0">iter</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> witness;</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// Given arrays of inputs, outputs, and witnesses, assemble the complete</span></span>
<span class="line"><span style="color:#6A737D">// transaction and serialize it for broadcast. Return bytes as hex-encoded string</span></span>
<span class="line"><span style="color:#6A737D">// suitable to broadcast with Bitcoin Core RPC.</span></span>
<span class="line"><span style="color:#6A737D">// https://en.bitcoin.it/wiki/Protocol_documentation#tx</span></span>
<span class="line"><span style="color:#F97583">fn</span><span style="color:#B392F0"> assemble_transaction</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#E1E4E8">    inputs</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Vec</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">Vec</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">>>,</span></span>
<span class="line"><span style="color:#E1E4E8">    outputs</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Vec</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">Utxo</span><span style="color:#E1E4E8">>,</span></span>
<span class="line"><span style="color:#E1E4E8">    witnesses</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Vec</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">Vec</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">>>,</span></span>
<span class="line"><span style="color:#E1E4E8">    is_p2sh</span><span style="color:#F97583">:</span><span style="color:#B392F0"> bool</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">) </span><span style="color:#F97583">-></span><span style="color:#B392F0"> Vec</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#F97583"> mut</span><span style="color:#E1E4E8"> transaction</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Vec</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">> </span><span style="color:#F97583">=</span><span style="color:#B392F0"> vec!</span><span style="color:#E1E4E8">[];</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> v1 </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 2</span><span style="color:#B392F0">u32</span><span style="color:#F97583">.</span><span style="color:#B392F0">to_le_bytes</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#6A737D">    // println!("\n======================\n");</span></span>
<span class="line"><span style="color:#6A737D">    // println!("Version: {:?}", hex::encode(v1.clone()));</span></span>
<span class="line"><span style="color:#E1E4E8">    transaction</span><span style="color:#F97583">.</span><span style="color:#B392F0">extend</span><span style="color:#E1E4E8">(v1</span><span style="color:#F97583">.</span><span style="color:#B392F0">iter</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#E1E4E8">    transaction</span><span style="color:#F97583">.</span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">0x00</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    transaction</span><span style="color:#F97583">.</span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">0x01</span><span style="color:#E1E4E8">); </span><span style="color:#6A737D">// for witness</span></span>
<span class="line"><span style="color:#6A737D">    // println!("Marker and Flag: {:?}", hex::encode([0x00, 0x01]));</span></span>
<span class="line"><span style="color:#E1E4E8">    transaction</span><span style="color:#F97583">.</span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">0x01</span><span style="color:#E1E4E8">); </span><span style="color:#6A737D">// num ins</span></span>
<span class="line"><span style="color:#6A737D">    // println!("Number of Inputs: {:?}", hex::encode([0x01]));</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> first_only_input </span><span style="color:#F97583">=</span><span style="color:#F97583"> &#x26;</span><span style="color:#E1E4E8">inputs[</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">];</span></span>
<span class="line"><span style="color:#E1E4E8">    transaction</span><span style="color:#F97583">.</span><span style="color:#B392F0">extend</span><span style="color:#E1E4E8">(first_only_input</span><span style="color:#F97583">.</span><span style="color:#B392F0">iter</span><span style="color:#E1E4E8">()); </span><span style="color:#6A737D">// first input ser</span></span>
<span class="line"><span style="color:#6A737D">    // println!("First Input: {:?}", hex::encode(first_only_input));</span></span>
<span class="line"><span style="color:#E1E4E8">    transaction</span><span style="color:#F97583">.</span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">0x02</span><span style="color:#E1E4E8">); </span><span style="color:#6A737D">// num outs </span></span>
<span class="line"><span style="color:#6A737D">    // println!("Number of Outputs: {:?}", hex::encode([0x02]));</span></span>
<span class="line"><span style="color:#F97583">    for</span><span style="color:#E1E4E8"> output </span><span style="color:#F97583">in</span><span style="color:#E1E4E8"> outputs {</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#E1E4E8"> out_ser </span><span style="color:#F97583">=</span><span style="color:#B392F0"> output_from_options</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">output</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">script_pubkey, output</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">amount);</span></span>
<span class="line"><span style="color:#E1E4E8">        transaction</span><span style="color:#F97583">.</span><span style="color:#B392F0">extend</span><span style="color:#E1E4E8">(out_ser</span><span style="color:#F97583">.</span><span style="color:#B392F0">iter</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> is_p2sh {</span></span>
<span class="line"><span style="color:#E1E4E8">        transaction</span><span style="color:#F97583">.</span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">0x04</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    } </span><span style="color:#F97583">else</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">        transaction</span><span style="color:#F97583">.</span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">0x02</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#6A737D">    // println!("Number of Witness Items: {:?}", hex::encode([0x02]));</span></span>
<span class="line"><span style="color:#6A737D">    // i hope this works :0</span></span>
<span class="line"><span style="color:#F97583">    for</span><span style="color:#E1E4E8"> witness </span><span style="color:#F97583">in</span><span style="color:#E1E4E8"> witnesses {</span></span>
<span class="line"><span style="color:#6A737D">        // let witness_len = witness.len() as u8;</span></span>
<span class="line"><span style="color:#6A737D">        // println!("Witness: {:?}", hex::encode(witness.clone()));</span></span>
<span class="line"><span style="color:#E1E4E8">        transaction</span><span style="color:#F97583">.</span><span style="color:#B392F0">extend</span><span style="color:#E1E4E8">(witness</span><span style="color:#F97583">.</span><span style="color:#B392F0">iter</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> locktime </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 0x00000000</span><span style="color:#B392F0">u32</span><span style="color:#F97583">.</span><span style="color:#B392F0">to_be_bytes</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#6A737D">    // println!("Locktime: {:?}", hex::encode(locktime.clone()));</span></span>
<span class="line"><span style="color:#E1E4E8">    transaction</span><span style="color:#F97583">.</span><span style="color:#B392F0">extend</span><span style="color:#E1E4E8">(locktime</span><span style="color:#F97583">.</span><span style="color:#B392F0">iter</span><span style="color:#E1E4E8">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> transaction;</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// Given arrays of inputs and outputs (no witnesses!) compute the txid.</span></span>
<span class="line"><span style="color:#6A737D">// Return the 32 byte txid as a *reversed* hex-encoded string.</span></span>
<span class="line"><span style="color:#6A737D">// https://developer.bitcoin.org/reference/transactions.html#raw-transaction-format</span></span>
<span class="line"><span style="color:#F97583">fn</span><span style="color:#B392F0"> get_txid</span><span style="color:#E1E4E8">(inputs</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Vec</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">Vec</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">>>, outputs</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Vec</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">Utxo</span><span style="color:#E1E4E8">>) </span><span style="color:#F97583">-></span><span style="color:#E1E4E8"> [</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">; </span><span style="color:#79B8FF">32</span><span style="color:#E1E4E8">] {</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#F97583"> mut</span><span style="color:#E1E4E8"> preimage</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Vec</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">> </span><span style="color:#F97583">=</span><span style="color:#B392F0"> vec!</span><span style="color:#E1E4E8">[];</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> v1 </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 2</span><span style="color:#B392F0">u32</span><span style="color:#F97583">.</span><span style="color:#B392F0">to_le_bytes</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">    preimage</span><span style="color:#F97583">.</span><span style="color:#B392F0">extend</span><span style="color:#E1E4E8">(v1</span><span style="color:#F97583">.</span><span style="color:#B392F0">iter</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> input_len </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> inputs</span><span style="color:#F97583">.</span><span style="color:#B392F0">len</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">as</span><span style="color:#B392F0"> u8</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">    preimage</span><span style="color:#F97583">.</span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">(input_len);</span></span>
<span class="line"><span style="color:#F97583">    for</span><span style="color:#E1E4E8"> input </span><span style="color:#F97583">in</span><span style="color:#E1E4E8"> inputs {</span></span>
<span class="line"><span style="color:#E1E4E8">        preimage</span><span style="color:#F97583">.</span><span style="color:#B392F0">extend</span><span style="color:#E1E4E8">(input</span><span style="color:#F97583">.</span><span style="color:#B392F0">iter</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> output_len </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> outputs</span><span style="color:#F97583">.</span><span style="color:#B392F0">len</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">as</span><span style="color:#B392F0"> u8</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">    preimage</span><span style="color:#F97583">.</span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">(output_len);</span></span>
<span class="line"><span style="color:#F97583">    for</span><span style="color:#E1E4E8"> output </span><span style="color:#F97583">in</span><span style="color:#E1E4E8"> outputs {</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#E1E4E8"> ser_out </span><span style="color:#F97583">=</span><span style="color:#B392F0"> output_from_options</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">output</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">script_pubkey, output</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">amount);</span></span>
<span class="line"><span style="color:#E1E4E8">        preimage</span><span style="color:#F97583">.</span><span style="color:#B392F0">extend</span><span style="color:#E1E4E8">(ser_out</span><span style="color:#F97583">.</span><span style="color:#B392F0">iter</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> lock_time </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 0x00000000</span><span style="color:#B392F0">u32</span><span style="color:#F97583">.</span><span style="color:#B392F0">to_be_bytes</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">    preimage</span><span style="color:#F97583">.</span><span style="color:#B392F0">extend</span><span style="color:#E1E4E8">(lock_time</span><span style="color:#F97583">.</span><span style="color:#B392F0">iter</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#F97583"> mut</span><span style="color:#E1E4E8"> internal </span><span style="color:#F97583">=</span><span style="color:#B392F0"> double_hash</span><span style="color:#E1E4E8">(preimage);</span></span>
<span class="line"><span style="color:#E1E4E8">    internal</span><span style="color:#F97583">.</span><span style="color:#B392F0">reverse</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> txid_try</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Result</span><span style="color:#E1E4E8">&#x3C;[</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">; 32], _> </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> internal</span><span style="color:#F97583">.</span><span style="color:#B392F0">try_into</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> txid </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> txid_try</span><span style="color:#F97583">.</span><span style="color:#B392F0">unwrap</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> txid</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// Spend a p2wpkh utxo to a 2 of 2 multisig p2wsh and return the (txid, transaction) tupple</span></span>
<span class="line"><span style="color:#F97583">pub</span><span style="color:#F97583"> fn</span><span style="color:#B392F0"> spend_p2wpkh</span><span style="color:#E1E4E8">(wallet_state</span><span style="color:#F97583">:</span><span style="color:#F97583"> &#x26;</span><span style="color:#B392F0">WalletState</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-></span><span style="color:#B392F0"> Result</span><span style="color:#E1E4E8">&#x3C;([</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">; 32], </span><span style="color:#B392F0">Vec</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">>), </span><span style="color:#B392F0">SpendError</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#6A737D">    // FEE = 1000</span></span>
<span class="line"><span style="color:#6A737D">    // AMT = 1000000</span></span>
<span class="line"><span style="color:#6A737D">    // Choose an unspent coin worth more than 0.01 BTC</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> utxos </span><span style="color:#F97583">=</span><span style="color:#F97583"> &#x26;</span><span style="color:#E1E4E8">wallet_state</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">utxos;</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#F97583"> mut</span><span style="color:#E1E4E8"> selected_outpoint</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Option</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#F97583">&#x26;</span><span style="color:#B392F0">OutgoingTx</span><span style="color:#E1E4E8">> </span><span style="color:#F97583">=</span><span style="color:#B392F0"> None</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">    for</span><span style="color:#E1E4E8"> utxo </span><span style="color:#F97583">in</span><span style="color:#E1E4E8"> utxos {</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8"> utxo</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">sats </span><span style="color:#F97583">></span><span style="color:#79B8FF"> 1_000_000</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">            selected_outpoint </span><span style="color:#F97583">=</span><span style="color:#B392F0"> Some</span><span style="color:#E1E4E8">(utxo);</span></span>
<span class="line"><span style="color:#F97583">            break</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // Create the input from the utxo</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> outpoint </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> selected_outpoint</span><span style="color:#F97583">.</span><span style="color:#B392F0">unwrap</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#6A737D">    // println!("Input SPK: {:?}", hex::encode(outpoint.spk.clone()));</span></span>
<span class="line"><span style="color:#6A737D">    // Reverse the txid hash so it's little-endian</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> input_external_txid </span><span style="color:#F97583">=</span><span style="color:#F97583"> &#x26;</span><span style="color:#E1E4E8">outpoint</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">pointer;</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#F97583"> mut</span><span style="color:#E1E4E8"> input_external_txid_bytes </span><span style="color:#F97583">=</span><span style="color:#B392F0"> hex</span><span style="color:#F97583">::</span><span style="color:#B392F0">decode</span><span style="color:#E1E4E8">(input_external_txid)</span><span style="color:#F97583">.</span><span style="color:#B392F0">expect</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Could not decode Input TXID."</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    input_external_txid_bytes</span><span style="color:#F97583">.</span><span style="color:#B392F0">reverse</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> attempt_internal</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Result</span><span style="color:#E1E4E8">&#x3C;[</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">; 32], _> </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> input_external_txid_bytes</span><span style="color:#F97583">.</span><span style="color:#B392F0">try_into</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> internal_repr </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> attempt_internal</span><span style="color:#F97583">.</span><span style="color:#B392F0">expect</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Could not fit TX hash to 32 bytes"</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> input </span><span style="color:#F97583">=</span><span style="color:#B392F0"> input_from_utxo</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">internal_repr, outpoint</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">out_point_index);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // Compute destination output script and output</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> pk1 </span><span style="color:#F97583">=</span><span style="color:#F97583"> &#x26;</span><span style="color:#E1E4E8">wallet_state</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">public_keys[</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">];</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> pk2 </span><span style="color:#F97583">=</span><span style="color:#F97583"> &#x26;</span><span style="color:#E1E4E8">wallet_state</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">public_keys[</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">];</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> raw_script </span><span style="color:#F97583">=</span><span style="color:#B392F0"> create_multisig_script</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">vec!</span><span style="color:#E1E4E8">[pk1</span><span style="color:#F97583">.</span><span style="color:#B392F0">to_vec</span><span style="color:#E1E4E8">(), pk2</span><span style="color:#F97583">.</span><span style="color:#B392F0">to_vec</span><span style="color:#E1E4E8">()]);</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> multisig_spk </span><span style="color:#F97583">=</span><span style="color:#B392F0"> get_p2wsh_program</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">raw_script, </span><span style="color:#B392F0">None</span><span style="color:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // Compute change output script and output</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> change </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> (outpoint</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">sats </span><span style="color:#F97583">-</span><span style="color:#79B8FF"> 1_000_000</span><span style="color:#F97583"> -</span><span style="color:#79B8FF"> 1_000</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">as</span><span style="color:#B392F0"> u32</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> change_utxo_output </span><span style="color:#F97583">=</span><span style="color:#B392F0">  Utxo</span><span style="color:#E1E4E8"> { script_pubkey</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> outpoint</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">spk</span><span style="color:#F97583">.</span><span style="color:#B392F0">clone</span><span style="color:#E1E4E8">(), amount</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> change </span><span style="color:#F97583">as</span><span style="color:#B392F0"> u32</span><span style="color:#E1E4E8"> };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> c_hash_output </span><span style="color:#F97583">=</span><span style="color:#B392F0"> Outpoint</span><span style="color:#E1E4E8"> { txid</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> internal_repr, index</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> outpoint</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">out_point_index };</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> txo </span><span style="color:#F97583">=</span><span style="color:#B392F0"> Utxo</span><span style="color:#E1E4E8"> { script_pubkey</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> outpoint</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">spk</span><span style="color:#F97583">.</span><span style="color:#B392F0">clone</span><span style="color:#E1E4E8">(), amount</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> change </span><span style="color:#F97583">as</span><span style="color:#B392F0"> u32</span><span style="color:#E1E4E8"> };</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> scriptcode </span><span style="color:#F97583">=</span><span style="color:#B392F0"> get_p2wpkh_scriptcode</span><span style="color:#E1E4E8">(txo);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> commited_outputs </span><span style="color:#F97583">=</span><span style="color:#B392F0"> vec!</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">Utxo</span><span style="color:#E1E4E8"> { script_pubkey</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> multisig_spk</span><span style="color:#F97583">.</span><span style="color:#B392F0">clone</span><span style="color:#E1E4E8">(), amount</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> 1_000_000</span><span style="color:#E1E4E8"> },</span></span>
<span class="line"><span style="color:#E1E4E8">                                                    change_utxo_output];</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> commit_hash </span><span style="color:#F97583">=</span><span style="color:#B392F0"> get_commitment_hash</span><span style="color:#E1E4E8">(c_hash_output, </span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">scriptcode, outpoint</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">sats </span><span style="color:#F97583">as</span><span style="color:#B392F0"> u32</span><span style="color:#E1E4E8">, commited_outputs);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // Fetch the private key we need to sign with</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#F97583"> mut</span><span style="color:#E1E4E8"> index_to_take</span><span style="color:#F97583">:</span><span style="color:#B392F0"> usize</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">    for</span><span style="color:#E1E4E8"> (index, script) </span><span style="color:#F97583">in</span><span style="color:#E1E4E8"> wallet_state</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">witness_programs</span><span style="color:#F97583">.</span><span style="color:#B392F0">iter</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">.</span><span style="color:#B392F0">enumerate</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8"> outpoint</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">spk</span><span style="color:#F97583">.</span><span style="color:#B392F0">eq</span><span style="color:#E1E4E8">(script) { </span><span style="color:#F97583">break</span><span style="color:#E1E4E8">; }</span></span>
<span class="line"><span style="color:#E1E4E8">        index_to_take </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> index_to_take </span><span style="color:#F97583">+</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> priv_key </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> wallet_state</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">private_keys[index_to_take];</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> found_pk </span><span style="color:#F97583">=</span><span style="color:#B392F0"> balance</span><span style="color:#F97583">::</span><span style="color:#B392F0">derive_public_key_from_private</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">priv_key</span><span style="color:#F97583">.</span><span style="color:#B392F0">clone</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#6A737D">    // println!("Found Private Key: {:?}", hex::encode(priv_key.clone()));</span></span>
<span class="line"><span style="color:#6A737D">    // println!("Found Public Key: {:?}", hex::encode(found_pk.clone()));</span></span>
<span class="line"><span style="color:#6A737D">    // println!("Confirming Witness Pubkey Matches: {:?}", hex::encode(balance::get_p2wpkh_program(found_pk)));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // Sign!</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> p2pkh_witness </span><span style="color:#F97583">=</span><span style="color:#B392F0"> get_p2wpkh_witness</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">priv_key, commit_hash);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // Assemble</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> multisig_utxo_output </span><span style="color:#F97583">=</span><span style="color:#B392F0"> Utxo</span><span style="color:#E1E4E8"> { script_pubkey</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> multisig_spk</span><span style="color:#F97583">.</span><span style="color:#B392F0">clone</span><span style="color:#E1E4E8">(), amount</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> 1_000_000</span><span style="color:#E1E4E8"> };</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> change_utxo_output </span><span style="color:#F97583">=</span><span style="color:#B392F0">  Utxo</span><span style="color:#E1E4E8"> { script_pubkey</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> outpoint</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">spk</span><span style="color:#F97583">.</span><span style="color:#B392F0">clone</span><span style="color:#E1E4E8">(), amount</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> change </span><span style="color:#F97583">as</span><span style="color:#B392F0"> u32</span><span style="color:#E1E4E8"> };</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> rawtx </span><span style="color:#F97583">=</span><span style="color:#B392F0"> assemble_transaction</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">vec!</span><span style="color:#E1E4E8">[input], </span><span style="color:#B392F0">vec!</span><span style="color:#E1E4E8">[multisig_utxo_output, change_utxo_output], </span><span style="color:#B392F0">vec!</span><span style="color:#E1E4E8">[p2pkh_witness], </span><span style="color:#79B8FF">false</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#6A737D">    // println!("Raw TX: {:?}\n\n", hex::encode(rawtx.clone()));</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#6A737D">    // Reserialize without witness data and double-SHA256 to get the txid</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> input </span><span style="color:#F97583">=</span><span style="color:#B392F0"> input_from_utxo</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">internal_repr, outpoint</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">out_point_index);</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> multisig_utxo_output </span><span style="color:#F97583">=</span><span style="color:#B392F0"> Utxo</span><span style="color:#E1E4E8"> { script_pubkey</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> multisig_spk</span><span style="color:#F97583">.</span><span style="color:#B392F0">clone</span><span style="color:#E1E4E8">(), amount</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> 1_000_000</span><span style="color:#E1E4E8"> };</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> change_utxo_output </span><span style="color:#F97583">=</span><span style="color:#B392F0">  Utxo</span><span style="color:#E1E4E8"> { script_pubkey</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> outpoint</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">spk</span><span style="color:#F97583">.</span><span style="color:#B392F0">clone</span><span style="color:#E1E4E8">(), amount</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> change </span><span style="color:#F97583">as</span><span style="color:#B392F0"> u32</span><span style="color:#E1E4E8"> };</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> commited_outputs </span><span style="color:#F97583">=</span><span style="color:#B392F0"> vec!</span><span style="color:#E1E4E8">[multisig_utxo_output, change_utxo_output];</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> txid </span><span style="color:#F97583">=</span><span style="color:#B392F0"> get_txid</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">vec!</span><span style="color:#E1E4E8">[input], commited_outputs);</span></span>
<span class="line"><span style="color:#6A737D">    // println!("{:?}", hex::encode(txid));</span></span>
<span class="line"><span style="color:#6A737D">    // For debugging you can use RPC `testmempoolaccept ["&#x3C;final hex>"]` here</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // return txid, final-tx</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#B392F0"> Ok</span><span style="color:#E1E4E8">((txid, rawtx));</span></span>
<span class="line"><span style="color:#E1E4E8"> </span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// Spend a 2-of-2 multisig p2wsh utxo and return the transaction</span></span>
<span class="line"><span style="color:#F97583">pub</span><span style="color:#F97583"> fn</span><span style="color:#B392F0"> spend_p2wsh</span><span style="color:#E1E4E8">(wallet_state</span><span style="color:#F97583">:</span><span style="color:#F97583"> &#x26;</span><span style="color:#B392F0">WalletState</span><span style="color:#E1E4E8">, txid</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> [</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">; </span><span style="color:#79B8FF">32</span><span style="color:#E1E4E8">]) </span><span style="color:#F97583">-></span><span style="color:#B392F0"> Result</span><span style="color:#E1E4E8">&#x3C;([</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">; 32], </span><span style="color:#B392F0">Vec</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">>), </span><span style="color:#B392F0">SpendError</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#6A737D">    // COIN_VALUE = 1000000</span></span>
<span class="line"><span style="color:#6A737D">    // FEE = 1000</span></span>
<span class="line"><span style="color:#6A737D">    // AMT = 0</span></span>
<span class="line"><span style="color:#6A737D">    // Create the input from the utxo</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> pk1 </span><span style="color:#F97583">=</span><span style="color:#F97583"> &#x26;</span><span style="color:#E1E4E8">wallet_state</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">public_keys[</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">];</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> pk2 </span><span style="color:#F97583">=</span><span style="color:#F97583"> &#x26;</span><span style="color:#E1E4E8">wallet_state</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">public_keys[</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">];</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> raw_script </span><span style="color:#F97583">=</span><span style="color:#B392F0"> create_multisig_script</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">vec!</span><span style="color:#E1E4E8">[pk1</span><span style="color:#F97583">.</span><span style="color:#B392F0">to_vec</span><span style="color:#E1E4E8">(), pk2</span><span style="color:#F97583">.</span><span style="color:#B392F0">to_vec</span><span style="color:#E1E4E8">()]);</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> multisig_spk </span><span style="color:#F97583">=</span><span style="color:#B392F0"> get_p2wsh_program</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">raw_script, </span><span style="color:#B392F0">None</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#6A737D">    // Reverse the txid hash so it's little-endian</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#F97583"> mut</span><span style="color:#E1E4E8"> input_external_txid_bytes </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> txid;</span></span>
<span class="line"><span style="color:#E1E4E8">    input_external_txid_bytes</span><span style="color:#F97583">.</span><span style="color:#B392F0">reverse</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> attempt_internal</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Result</span><span style="color:#E1E4E8">&#x3C;[</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">; 32], _> </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> input_external_txid_bytes</span><span style="color:#F97583">.</span><span style="color:#B392F0">try_into</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> internal_repr </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> attempt_internal</span><span style="color:#F97583">.</span><span style="color:#B392F0">expect</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Could not fit TX hash to 32 bytes"</span><span style="color:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> tx_input </span><span style="color:#F97583">=</span><span style="color:#B392F0"> input_from_utxo</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">internal_repr, </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // Compute destination output script and output</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#F97583"> mut</span><span style="color:#E1E4E8"> op_return_spk </span><span style="color:#F97583">=</span><span style="color:#B392F0"> vec!</span><span style="color:#E1E4E8">[];</span></span>
<span class="line"><span style="color:#E1E4E8">    op_return_spk</span><span style="color:#F97583">.</span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">0x6a</span><span style="color:#E1E4E8">); </span><span style="color:#6A737D">// OP_RETURN</span></span>
<span class="line"><span style="color:#E1E4E8">    op_return_spk</span><span style="color:#F97583">.</span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">0x03</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    op_return_spk</span><span style="color:#F97583">.</span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">0x72</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    op_return_spk</span><span style="color:#F97583">.</span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">0x4f</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    op_return_spk</span><span style="color:#F97583">.</span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">0x42</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> op_return_utxo </span><span style="color:#F97583">=</span><span style="color:#B392F0"> Utxo</span><span style="color:#E1E4E8"> { script_pubkey</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> op_return_spk, amount</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8"> };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // Compute change output script and output</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> change_spk </span><span style="color:#F97583">=</span><span style="color:#B392F0"> balance</span><span style="color:#F97583">::</span><span style="color:#B392F0">get_p2wpkh_program</span><span style="color:#E1E4E8">(pk1</span><span style="color:#F97583">.</span><span style="color:#B392F0">clone</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> change_utxo </span><span style="color:#F97583">=</span><span style="color:#B392F0"> Utxo</span><span style="color:#E1E4E8"> { script_pubkey</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> change_spk</span><span style="color:#F97583">.</span><span style="color:#B392F0">to_vec</span><span style="color:#E1E4E8">(), amount</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> 1_000_000</span><span style="color:#F97583"> -</span><span style="color:#79B8FF"> 1_000</span><span style="color:#E1E4E8"> };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // Get the message to sign</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#F97583"> mut</span><span style="color:#E1E4E8"> scriptcode</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Vec</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">> </span><span style="color:#F97583">=</span><span style="color:#B392F0"> vec!</span><span style="color:#E1E4E8">[];</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> output_l </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> raw_script</span><span style="color:#F97583">.</span><span style="color:#B392F0">len</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">as</span><span style="color:#B392F0"> u8</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">    scriptcode</span><span style="color:#F97583">.</span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">(output_l);</span></span>
<span class="line"><span style="color:#E1E4E8">    scriptcode</span><span style="color:#F97583">.</span><span style="color:#B392F0">extend</span><span style="color:#E1E4E8">(raw_script</span><span style="color:#F97583">.</span><span style="color:#B392F0">clone</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">.</span><span style="color:#B392F0">iter</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> commitment </span><span style="color:#F97583">=</span><span style="color:#B392F0"> get_commitment_hash</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">Outpoint</span><span style="color:#E1E4E8"> { txid</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> internal_repr, index</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8"> }, </span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">scriptcode, </span><span style="color:#79B8FF">1_000_000</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">vec!</span><span style="color:#E1E4E8">[op_return_utxo, change_utxo]);</span></span>
<span class="line"><span style="color:#6A737D">    // Sign!</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> priv_key_1 </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> wallet_state</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">private_keys[</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">];</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> priv_key_2 </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> wallet_state</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">private_keys[</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">];</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> witness </span><span style="color:#F97583">=</span><span style="color:#B392F0"> get_p2wsh_witness</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">vec!</span><span style="color:#E1E4E8">[</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">priv_key_1, </span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">priv_key_2], commitment);</span></span>
<span class="line"><span style="color:#6A737D">    // Assemble</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#F97583"> mut</span><span style="color:#E1E4E8"> op_return_spk </span><span style="color:#F97583">=</span><span style="color:#B392F0"> vec!</span><span style="color:#E1E4E8">[];</span></span>
<span class="line"><span style="color:#E1E4E8">    op_return_spk</span><span style="color:#F97583">.</span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">0x6a</span><span style="color:#E1E4E8">); </span><span style="color:#6A737D">// OP_RETURN</span></span>
<span class="line"><span style="color:#E1E4E8">    op_return_spk</span><span style="color:#F97583">.</span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">0x03</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    op_return_spk</span><span style="color:#F97583">.</span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">0x72</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    op_return_spk</span><span style="color:#F97583">.</span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">0x4f</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    op_return_spk</span><span style="color:#F97583">.</span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">0x42</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> op_return_utxo </span><span style="color:#F97583">=</span><span style="color:#B392F0"> Utxo</span><span style="color:#E1E4E8"> { script_pubkey</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> op_return_spk, amount</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8"> };</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> change_spk </span><span style="color:#F97583">=</span><span style="color:#B392F0"> balance</span><span style="color:#F97583">::</span><span style="color:#B392F0">get_p2wpkh_program</span><span style="color:#E1E4E8">(pk1</span><span style="color:#F97583">.</span><span style="color:#B392F0">clone</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> change_utxo </span><span style="color:#F97583">=</span><span style="color:#B392F0"> Utxo</span><span style="color:#E1E4E8"> { script_pubkey</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> change_spk</span><span style="color:#F97583">.</span><span style="color:#B392F0">to_vec</span><span style="color:#E1E4E8">(), amount</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> 1_000_000</span><span style="color:#F97583"> -</span><span style="color:#79B8FF"> 1_000</span><span style="color:#E1E4E8"> };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> rawtx </span><span style="color:#F97583">=</span><span style="color:#B392F0"> assemble_transaction</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">vec!</span><span style="color:#E1E4E8">[tx_input], </span><span style="color:#B392F0">vec!</span><span style="color:#E1E4E8">[op_return_utxo, change_utxo], </span><span style="color:#B392F0">vec!</span><span style="color:#E1E4E8">[witness], </span><span style="color:#79B8FF">true</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#6A737D">    // For debugging you can use RPC `testmempoolaccept ["&#x3C;final hex>"]` here</span></span>
<span class="line"><span style="color:#6A737D">    // println!("{}", hex::encode(rawtx.clone()));</span></span>
<span class="line"><span style="color:#6A737D">    // return txid final-tx</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> tx_input </span><span style="color:#F97583">=</span><span style="color:#B392F0"> input_from_utxo</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">internal_repr, </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#F97583"> mut</span><span style="color:#E1E4E8"> op_return_spk </span><span style="color:#F97583">=</span><span style="color:#B392F0"> vec!</span><span style="color:#E1E4E8">[];</span></span>
<span class="line"><span style="color:#E1E4E8">    op_return_spk</span><span style="color:#F97583">.</span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">0x6a</span><span style="color:#E1E4E8">); </span><span style="color:#6A737D">// OP_RETURN</span></span>
<span class="line"><span style="color:#E1E4E8">    op_return_spk</span><span style="color:#F97583">.</span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">0x03</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    op_return_spk</span><span style="color:#F97583">.</span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">0x72</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    op_return_spk</span><span style="color:#F97583">.</span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">0x4f</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    op_return_spk</span><span style="color:#F97583">.</span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">0x42</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> op_return_utxo </span><span style="color:#F97583">=</span><span style="color:#B392F0"> Utxo</span><span style="color:#E1E4E8"> { script_pubkey</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> op_return_spk, amount</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8"> };</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> change_spk </span><span style="color:#F97583">=</span><span style="color:#B392F0"> balance</span><span style="color:#F97583">::</span><span style="color:#B392F0">get_p2wpkh_program</span><span style="color:#E1E4E8">(pk1</span><span style="color:#F97583">.</span><span style="color:#B392F0">clone</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> change_utxo </span><span style="color:#F97583">=</span><span style="color:#B392F0"> Utxo</span><span style="color:#E1E4E8"> { script_pubkey</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> change_spk</span><span style="color:#F97583">.</span><span style="color:#B392F0">to_vec</span><span style="color:#E1E4E8">(), amount</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> 1_000_000</span><span style="color:#F97583"> -</span><span style="color:#79B8FF"> 1_000</span><span style="color:#E1E4E8"> };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> txid </span><span style="color:#F97583">=</span><span style="color:#B392F0"> get_txid</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">vec!</span><span style="color:#E1E4E8">[tx_input], </span><span style="color:#B392F0">vec!</span><span style="color:#E1E4E8">[op_return_utxo, change_utxo]);</span></span>
<span class="line"><span style="color:#6A737D">    // println!("{}", hex::encode(txid));</span></span>
<span class="line"><span style="color:#B392F0">    Ok</span><span style="color:#E1E4E8">((txid, rawtx))</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </article>  </div>  </main> <footer class="animate"> <div class="mx-auto max-w-screen-sm px-5">  <div class="relative"> <div class="absolute right-0 -top-20"> <button id="back-to-top" class="relative group w-fit flex pl-8 pr-3 py-1.5 flex-nowrap rounded border border-black/15 dark:border-white/20 hover:bg-black/5 dark:hover:bg-white/5 hover:text-black dark:hover:text-white transition-colors duration-300 ease-in-out"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="absolute top-1/2 left-2 -translate-y-1/2 size-4 stroke-2 fill-none stroke-current rotate-90"> <line x1="5" y1="12" x2="19" y2="12" class="translate-x-2 group-hover:translate-x-0 scale-x-0 group-hover:scale-x-100 transition-transform duration-300 ease-in-out"></line> <polyline points="12 5 5 12 12 19" class="translate-x-1 group-hover:translate-x-0 transition-transform duration-300 ease-in-out"></polyline> </svg> <div class="text-sm">
Back to top
</div> </button> </div> </div> <div class="flex justify-between items-center"> <div>
&copy; 2024 | @rustaceanrob </div> <div class="flex flex-wrap gap-1 items-center"> <button id="light-theme-button" aria-label="Light theme" class="group size-8 flex items-center justify-center rounded-full"> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="group-hover:stroke-black group-hover:dark:stroke-white transition-colors duration-300 ease-in-out"> <circle cx="12" cy="12" r="5"></circle> <line x1="12" y1="1" x2="12" y2="3"></line> <line x1="12" y1="21" x2="12" y2="23"></line> <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line> <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line> <line x1="1" y1="12" x2="3" y2="12"></line> <line x1="21" y1="12" x2="23" y2="12"></line> <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line> <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line> </svg> </button> <button id="dark-theme-button" aria-label="Dark theme" class="group size-8 flex items-center justify-center rounded-full"> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="group-hover:stroke-black group-hover:dark:stroke-white transition-colors duration-300 ease-in-out"> <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path> </svg> </button> <button id="system-theme-button" aria-label="System theme" class="group size-8 flex items-center justify-center rounded-full"> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="group-hover:stroke-black group-hover:dark:stroke-white transition-colors duration-300 ease-in-out"> <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect> <line x1="8" y1="21" x2="16" y2="21"></line> <line x1="12" y1="17" x2="12" y2="21"></line> </svg> </button> </div> </div>  </div> </footer> </body></html>