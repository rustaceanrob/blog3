<!DOCTYPE html><html lang="en"> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" type="image/svg+xml" href="/rust.png" media="(prefers-color-scheme: dark)"><link rel="icon" type="image/svg+xml" href="/rust.png" media="(prefers-color-scheme: light)"><link rel="icon" type="image/x-icon" href="/rust.png"><meta name="generator" content="Astro v4.15.4"><!-- Font preloads --><link rel="preload" href="/_astro/inter-latin-400-normal.BT1H-PT_.woff2" as="font" type="font/woff2" crossorigin><link rel="preload" href="/_astro/inter-latin-600-normal.B2Ssfs8e.woff2" as="font" type="font/woff2" crossorigin><link rel="preload" href="/_astro/lora-latin-400-normal.CvHVDnm4.woff2" as="font" type="font/woff2" crossorigin><link rel="preload" href="/_astro/lora-latin-600-normal.DUWh3m6k.woff2" as="font" type="font/woff2" crossorigin><!-- Canonical URL --><link rel="canonical" href="https://robnetzke.com/blog/02-bip32/"><!-- Primary Meta Tags --><title>Bitcoin Improvement Proposal 32 | @rustaceanrob</title><meta name="title" content="Bitcoin Improvement Proposal 32 | @rustaceanrob"><meta name="description" content="The internals of a bitcoin wallet, built from scratch in Rust"><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://robnetzke.com/blog/02-bip32/"><meta property="og:title" content="Bitcoin Improvement Proposal 32 | @rustaceanrob"><meta property="og:description" content="The internals of a bitcoin wallet, built from scratch in Rust"><meta property="og:image" content="https://robnetzke.com/nano.png"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://robnetzke.com/blog/02-bip32/"><meta property="twitter:title" content="Bitcoin Improvement Proposal 32 | @rustaceanrob"><meta property="twitter:description" content="The internals of a bitcoin wallet, built from scratch in Rust"><meta property="twitter:image" content="https://robnetzke.com/nano.png"><meta name="astro-view-transitions-enabled" content="true"><meta name="astro-view-transitions-fallback" content="animate"><script>
  function init() {
    preloadTheme();
    onScroll();
    animate();

    const backToTop = document.getElementById("back-to-top");
    backToTop?.addEventListener("click", (event) => scrollToTop(event));

    const backToPrev = document.getElementById("back-to-prev");
    backToPrev?.addEventListener("click", () => window.history.back());

    const lightThemeButton = document.getElementById("light-theme-button");
    lightThemeButton?.addEventListener("click", () => {
      localStorage.setItem("theme", "light");
      toggleTheme(false);
    });

    const darkThemeButton = document.getElementById("dark-theme-button");
    darkThemeButton?.addEventListener("click", () => {
      localStorage.setItem("theme", "dark");
      toggleTheme(true);
    });

    const systemThemeButton = document.getElementById("system-theme-button");
    systemThemeButton?.addEventListener("click", () => {
      localStorage.setItem("theme", "system");
      toggleTheme(window.matchMedia("(prefers-color-scheme: dark)").matches);
    });

    window.matchMedia("(prefers-color-scheme: dark)")
      .addEventListener("change", event => {
        if (localStorage.theme === "system") {
          toggleTheme(event.matches);
        }
      }
    );

    document.addEventListener("scroll", onScroll);
  }

  function animate() {
    const animateElements = document.querySelectorAll(".animate");

    animateElements.forEach((element, index) => {
      setTimeout(() => {
        element.classList.add("show");
      }, index * 150);
    });
  }

  function onScroll() {
    if (window.scrollY > 0) {
      document.documentElement.classList.add("scrolled");
    } else {
      document.documentElement.classList.remove("scrolled");
    }
  }

  function scrollToTop(event) {
    event.preventDefault();
    window.scrollTo({
      top: 0,
      behavior: "smooth"
    });
  }

function toggleTheme(dark) {
    const css = document.createElement("style");

    css.appendChild(
      document.createTextNode(
        `* {
             -webkit-transition: none !important;
             -moz-transition: none !important;
             -o-transition: none !important;
             -ms-transition: none !important;
             transition: none !important;
          }
        `,
      )
    );

    document.head.appendChild(css);

    if (dark) {
      document.documentElement.classList.add("dark");
    } else {
      document.documentElement.classList.remove("dark");
    }

  window.getComputedStyle(css).opacity;
    document.head.removeChild(css);
  }

  function preloadTheme() {
    const userTheme = localStorage.theme;

    if (userTheme === "light" || userTheme === "dark") {
      toggleTheme(userTheme === "dark");
    } else {
      toggleTheme(window.matchMedia("(prefers-color-scheme: dark)").matches);
    }
  }

  document.addEventListener("DOMContentLoaded", () => init());
  document.addEventListener("astro:after-swap", () => init());
  preloadTheme();
</script><link rel="stylesheet" href="/_astro/_slug_.9cf2N-Ct.css"><script type="module" src="/_astro/hoisted.JmkTFhge.js"></script></head> <body> <header> <div class="mx-auto max-w-screen-sm px-5">  <div class="flex flex-wrap gap-y-2 justify-between"> <a href="/" target="_self" class="inline-block decoration-black/15 dark:decoration-white/30 hover:decoration-black/25 hover:dark:decoration-white/50 text-current hover:text-black hover:dark:text-white transition-colors duration-300 ease-in-out">  <div class="font-semibold"> @rustaceanrob </div>  </a> <nav class="flex gap-1"> <a href="/blog" target="_self" class="inline-block decoration-black/15 dark:decoration-white/30 hover:decoration-black/25 hover:dark:decoration-white/50 text-current hover:text-black hover:dark:text-white transition-colors duration-300 ease-in-out underline underline-offset-2"> 
blog
 </a> <span> / </span> <a href="/work" target="_self" class="inline-block decoration-black/15 dark:decoration-white/30 hover:decoration-black/25 hover:dark:decoration-white/50 text-current hover:text-black hover:dark:text-white transition-colors duration-300 ease-in-out underline underline-offset-2"> 
work
 </a> <!-- <span>
          {`/`}
        </span> --> <!-- <Link href="/projects">
          projects
        </Link> --> </nav> </div>  </div> </header> <main>  <div class="mx-auto max-w-screen-sm px-5">  <div class="animate"> <a href="/blog" class="relative group w-fit flex pl-7 pr-3 py-1.5 flex-nowrap rounded border border-black/15 dark:border-white/20 hover:bg-black/5 dark:hover:bg-white/5 hover:text-black dark:hover:text-white transition-colors duration-300 ease-in-out"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="absolute top-1/2 left-2 -translate-y-1/2 size-4 stroke-2 fill-none stroke-current"> <line x1="5" y1="12" x2="19" y2="12" class="translate-x-2 group-hover:translate-x-0 scale-x-0 group-hover:scale-x-100 transition-transform duration-300 ease-in-out"></line> <polyline points="12 5 5 12 12 19" class="translate-x-1 group-hover:translate-x-0 transition-transform duration-300 ease-in-out"></polyline> </svg> <div class="text-sm"> 
Back to blog
 </div> </a> </div> <div class="space-y-1 my-10"> <div class="animate flex items-center gap-1.5"> <div class="font-base text-sm"> <time datetime="2024-01-23T10:00:00.000Z"> Jan 23, 2024 </time> </div>
&bull;
<div class="font-base text-sm"> 9 min read </div> </div> <div class="animate text-2xl font-semibold text-black dark:text-white"> Bitcoin Improvement Proposal 32 </div> </div> <article class="animate"> <h2 id="context">Context</h2>
<p>This exercise was completed as part of the <strong>Chaincode: Start Your Career in FOSS</strong> program. BIP32 (and BIP39) is a specification for wallet developers that makes wallet recovery as simple as possible for users without security compromises. I built an implementation from scratch with some pretty terrible code that would never come close to a production environment. The output is what matters (:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#F97583">extern</span><span style="color:#F97583"> crate</span><span style="color:#E1E4E8"> bitcoincore_rpc;</span></span>
<span class="line"><span style="color:#F97583">use</span><span style="color:#B392F0"> bitcoincore_rpc</span><span style="color:#F97583">::</span><span style="color:#E1E4E8">{</span><span style="color:#B392F0">Auth</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">Client</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">RpcApi</span><span style="color:#E1E4E8">};</span></span>
<span class="line"><span style="color:#F97583">use</span><span style="color:#E1E4E8"> bs58;</span></span>
<span class="line"><span style="color:#F97583">use</span><span style="color:#E1E4E8"> hex;</span></span>
<span class="line"><span style="color:#F97583">use</span><span style="color:#B392F0"> hmac_sha512</span><span style="color:#F97583">::</span><span style="color:#B392F0">HMAC</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">use</span><span style="color:#B392F0"> num_bigint</span><span style="color:#F97583">::</span><span style="color:#B392F0">BigUint</span><span style="color:#E1E4E8">; </span><span style="color:#F97583">use</span><span style="color:#B392F0"> ripemd</span><span style="color:#F97583">::</span><span style="color:#B392F0">digest</span><span style="color:#F97583">::</span><span style="color:#E1E4E8">{</span><span style="color:#B392F0">FixedOutput</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">Update</span><span style="color:#E1E4E8">};</span></span>
<span class="line"><span style="color:#F97583">use</span><span style="color:#B392F0"> ripemd</span><span style="color:#F97583">::</span><span style="color:#B392F0">digest</span><span style="color:#F97583">::</span><span style="color:#B392F0">crypto_common</span><span style="color:#F97583">::</span><span style="color:#B392F0">KeyInit</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#6A737D">// for modulus math on large numbers</span></span>
<span class="line"><span style="color:#F97583">use</span><span style="color:#B392F0"> ripemd</span><span style="color:#F97583">::</span><span style="color:#E1E4E8">{</span><span style="color:#B392F0">Ripemd160</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">Ripemd160Core</span><span style="color:#E1E4E8">};</span></span>
<span class="line"><span style="color:#F97583">use</span><span style="color:#B392F0"> secp256k1</span><span style="color:#F97583">::</span><span style="color:#E1E4E8">{</span><span style="color:#B392F0">Secp256k1</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">SecretKey</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">PublicKey</span><span style="color:#E1E4E8">};</span></span>
<span class="line"><span style="color:#F97583">use</span><span style="color:#B392F0"> sha2</span><span style="color:#F97583">::</span><span style="color:#E1E4E8">{</span><span style="color:#B392F0">Sha256</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">Digest</span><span style="color:#E1E4E8">};</span></span>
<span class="line"><span style="color:#F97583">use</span><span style="color:#B392F0"> std</span><span style="color:#F97583">::</span><span style="color:#B392F0">error</span><span style="color:#F97583">::</span><span style="color:#B392F0">Error</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">use</span><span style="color:#B392F0"> std</span><span style="color:#F97583">::</span><span style="color:#B392F0">hash</span><span style="color:#F97583">::</span><span style="color:#B392F0">Hash</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">use</span><span style="color:#B392F0"> std</span><span style="color:#F97583">::</span><span style="color:#B392F0">io</span><span style="color:#F97583">::</span><span style="color:#E1E4E8">{</span><span style="color:#B392F0">Read</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">Write</span><span style="color:#E1E4E8">};</span></span>
<span class="line"><span style="color:#F97583">use</span><span style="color:#B392F0"> std</span><span style="color:#F97583">::</span><span style="color:#B392F0">ops</span><span style="color:#F97583">::</span><span style="color:#B392F0">Add</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">use</span><span style="color:#B392F0"> std</span><span style="color:#F97583">::</span><span style="color:#B392F0">path</span><span style="color:#F97583">::</span><span style="color:#B392F0">PathBuf</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">use</span><span style="color:#B392F0"> std</span><span style="color:#F97583">::</span><span style="color:#B392F0">str</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// Provided by administrator</span></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> WALLET_NAME</span><span style="color:#F97583">:</span><span style="color:#F97583"> &#x26;</span><span style="color:#B392F0">str</span><span style="color:#F97583"> =</span><span style="color:#9ECBFF"> "wallet_164"</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> EXTENDED_PRIVATE_KEY</span><span style="color:#F97583">:</span><span style="color:#F97583"> &#x26;</span><span style="color:#B392F0">str</span><span style="color:#F97583"> =</span><span style="color:#9ECBFF"> "tprv8ZgxMBicQKsPdpZe8dbST5dNjj5UkA9MDWR9MKZw4vdHoJ27dXZbWSGBE7BgaURHs3A649nhUsKcDvQbGVHUQRY68jHKEu6XzDz4Kq5pWGa"</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> HARDENED_OFFSET</span><span style="color:#F97583">:</span><span style="color:#B392F0"> u32</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> 2_</span><span style="color:#B392F0">u32</span><span style="color:#F97583">.</span><span style="color:#B392F0">pow</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">31</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> CURVE_ORDER</span><span style="color:#F97583">:</span><span style="color:#F97583"> &#x26;</span><span style="color:#B392F0">str</span><span style="color:#F97583"> =</span><span style="color:#9ECBFF"> "FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEBAAEDCE6AF48A03BBFD25E8CD0364141"</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">#[derive(</span><span style="color:#B392F0">Debug</span><span style="color:#E1E4E8">)]</span></span>
<span class="line"><span style="color:#F97583">struct</span><span style="color:#B392F0"> ExtendedKey</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    pub</span><span style="color:#E1E4E8"> version_bytes</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> [</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">; </span><span style="color:#79B8FF">4</span><span style="color:#E1E4E8">],</span></span>
<span class="line"><span style="color:#F97583">    pub</span><span style="color:#E1E4E8"> depth</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> [</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">; </span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">],</span></span>
<span class="line"><span style="color:#F97583">    pub</span><span style="color:#E1E4E8"> finger_print</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> [</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">; </span><span style="color:#79B8FF">4</span><span style="color:#E1E4E8">],</span></span>
<span class="line"><span style="color:#F97583">    pub</span><span style="color:#E1E4E8"> child_number</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> [</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">; </span><span style="color:#79B8FF">4</span><span style="color:#E1E4E8">],</span></span>
<span class="line"><span style="color:#F97583">    pub</span><span style="color:#E1E4E8"> chain_code</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> [</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">; </span><span style="color:#79B8FF">32</span><span style="color:#E1E4E8">],</span></span>
<span class="line"><span style="color:#F97583">    pub</span><span style="color:#E1E4E8"> key</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> [</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">; </span><span style="color:#79B8FF">33</span><span style="color:#E1E4E8">],</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">struct</span><span style="color:#B392F0"> ChildKey</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    pub</span><span style="color:#E1E4E8"> priv_key</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> [</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">; </span><span style="color:#79B8FF">32</span><span style="color:#E1E4E8">],</span></span>
<span class="line"><span style="color:#F97583">    pub</span><span style="color:#E1E4E8"> chain_code</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> [</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">; </span><span style="color:#79B8FF">32</span><span style="color:#E1E4E8">],</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">pub</span><span style="color:#F97583"> struct</span><span style="color:#B392F0"> OutgoingTx</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    pub</span><span style="color:#E1E4E8"> sats</span><span style="color:#F97583">:</span><span style="color:#B392F0"> u64</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#F97583">    pub</span><span style="color:#E1E4E8"> pointer</span><span style="color:#F97583">:</span><span style="color:#B392F0"> String</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">struct</span><span style="color:#B392F0"> SpendingTx</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    pub</span><span style="color:#E1E4E8"> prev_out</span><span style="color:#F97583">:</span><span style="color:#B392F0"> String</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// final wallet state struct</span></span>
<span class="line"><span style="color:#F97583">pub</span><span style="color:#F97583"> struct</span><span style="color:#B392F0"> WalletState</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    pub</span><span style="color:#E1E4E8"> utxos</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Vec</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">OutgoingTx</span><span style="color:#E1E4E8">>,</span></span>
<span class="line"><span style="color:#E1E4E8">    witness_programs</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Vec</span><span style="color:#E1E4E8">&#x3C;[</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">; 22]>,</span></span>
<span class="line"><span style="color:#E1E4E8">    public_keys</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Vec</span><span style="color:#E1E4E8">&#x3C;[</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">; 33]>,</span></span>
<span class="line"><span style="color:#E1E4E8">    private_keys</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Vec</span><span style="color:#E1E4E8">&#x3C;[</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">; 32]>,</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// Decode a base58 string into an array of bytes</span></span>
<span class="line"><span style="color:#F97583">fn</span><span style="color:#B392F0"> base58_decode</span><span style="color:#E1E4E8">(base58_string</span><span style="color:#F97583">:</span><span style="color:#F97583"> &#x26;</span><span style="color:#B392F0">str</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-></span><span style="color:#B392F0"> Vec</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> base58_alphabet </span><span style="color:#F97583">=</span><span style="color:#9ECBFF"> "123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // Convert Base58 string to a big integer</span></span>
<span class="line"><span style="color:#6A737D">    // Convert the integer to bytes</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> full_decoded </span><span style="color:#F97583">=</span><span style="color:#B392F0"> bs58</span><span style="color:#F97583">::</span><span style="color:#B392F0">decode</span><span style="color:#E1E4E8">(base58_string)</span></span>
<span class="line"><span style="color:#F97583">                                                .</span><span style="color:#B392F0">into_vec</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#F97583">                                                .</span><span style="color:#B392F0">expect</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Decoding failed."</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> cs </span><span style="color:#F97583">=</span><span style="color:#F97583"> &#x26;</span><span style="color:#E1E4E8">full_decoded[full_decoded</span><span style="color:#F97583">.</span><span style="color:#B392F0">len</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">-</span><span style="color:#79B8FF"> 4</span><span style="color:#F97583">..</span><span style="color:#E1E4E8">];</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // Chop off the 32 checksum bits and return</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#F97583"> mut</span><span style="color:#E1E4E8"> decoded </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> full_decoded</span><span style="color:#F97583">.</span><span style="color:#B392F0">clone</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">    decoded</span><span style="color:#F97583">.</span><span style="color:#B392F0">truncate</span><span style="color:#E1E4E8">(decoded</span><span style="color:#F97583">.</span><span style="color:#B392F0">len</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">-</span><span style="color:#79B8FF"> 4</span><span style="color:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // BONUS POINTS: Verify the checksum!</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#F97583"> mut</span><span style="color:#E1E4E8"> hasher </span><span style="color:#F97583">=</span><span style="color:#B392F0"> Sha256</span><span style="color:#F97583">::</span><span style="color:#B392F0">new</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">    hasher</span><span style="color:#F97583">.</span><span style="color:#B392F0">write</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">decoded</span><span style="color:#F97583">.</span><span style="color:#B392F0">clone</span><span style="color:#E1E4E8">())</span><span style="color:#F97583">.</span><span style="color:#B392F0">expect</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Hash failed."</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> first_digest </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> hasher</span><span style="color:#F97583">.</span><span style="color:#B392F0">finalize_fixed</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> digest_bytes </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> first_digest</span><span style="color:#F97583">.</span><span style="color:#B392F0">to_vec</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#F97583"> mut</span><span style="color:#E1E4E8"> hasher </span><span style="color:#F97583">=</span><span style="color:#B392F0"> Sha256</span><span style="color:#F97583">::</span><span style="color:#B392F0">new</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">    hasher</span><span style="color:#F97583">.</span><span style="color:#B392F0">write</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">digest_bytes</span><span style="color:#F97583">.</span><span style="color:#B392F0">clone</span><span style="color:#E1E4E8">())</span><span style="color:#F97583">.</span><span style="color:#B392F0">expect</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Hash failed."</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> second_digest </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> hasher</span><span style="color:#F97583">.</span><span style="color:#B392F0">finalize_fixed</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> digest_bytes </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> second_digest</span><span style="color:#F97583">.</span><span style="color:#B392F0">to_vec</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> challenge </span><span style="color:#F97583">=</span><span style="color:#F97583"> &#x26;</span><span style="color:#E1E4E8">digest_bytes[</span><span style="color:#79B8FF">0</span><span style="color:#F97583">..</span><span style="color:#79B8FF">4</span><span style="color:#E1E4E8">];</span></span>
<span class="line"><span style="color:#B392F0">    assert_eq!</span><span style="color:#E1E4E8">(challenge, cs);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> decoded</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// Deserialize the extended key bytes and return a JSON object</span></span>
<span class="line"><span style="color:#6A737D">// https://github.com/bitcoin/bips/blob/master/bip-0032.mediawiki#serialization-format</span></span>
<span class="line"><span style="color:#6A737D">// 4 byte: version bytes (mainnet: 0x0488B21E public, 0x0488ADE4 private; testnet: 0x043587CF public, 0x04358394 private)</span></span>
<span class="line"><span style="color:#6A737D">// 1 byte: depth: 0x00 for master nodes, 0x01 for level-1 derived keys, ....</span></span>
<span class="line"><span style="color:#6A737D">// 4 bytes: the fingerprint of the parents key (0x00000000 if master key)</span></span>
<span class="line"><span style="color:#6A737D">// 4 bytes: child number. This is ser32(i) for i in xi = xpar/i, with xi the key being serialized. (0x00000000 if master key)</span></span>
<span class="line"><span style="color:#6A737D">// 32 bytes: the chain code</span></span>
<span class="line"><span style="color:#6A737D">// 33 bytes: the public key or private key data (serP(K) for public keys, 0x00 || ser256(k) for private keys)</span></span>
<span class="line"><span style="color:#F97583">fn</span><span style="color:#B392F0"> deserialize_key</span><span style="color:#E1E4E8">(bytes</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Vec</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">>) </span><span style="color:#F97583">-></span><span style="color:#B392F0"> ExtendedKey</span><span style="color:#E1E4E8"> {  </span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> version_bytes</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Result</span><span style="color:#E1E4E8">&#x3C;[</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">; 4], _> </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> bytes[</span><span style="color:#79B8FF">0</span><span style="color:#F97583">..</span><span style="color:#79B8FF">4</span><span style="color:#E1E4E8">]</span><span style="color:#F97583">.</span><span style="color:#B392F0">try_into</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> depth</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Result</span><span style="color:#E1E4E8">&#x3C;[</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">; 1], _> </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> bytes[</span><span style="color:#79B8FF">4</span><span style="color:#F97583">..</span><span style="color:#79B8FF">5</span><span style="color:#E1E4E8">]</span><span style="color:#F97583">.</span><span style="color:#B392F0">try_into</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> finger_print</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Result</span><span style="color:#E1E4E8">&#x3C;[</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">; 4], _> </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> bytes[</span><span style="color:#79B8FF">5</span><span style="color:#F97583">..</span><span style="color:#79B8FF">9</span><span style="color:#E1E4E8">]</span><span style="color:#F97583">.</span><span style="color:#B392F0">try_into</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> child_number</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Result</span><span style="color:#E1E4E8">&#x3C;[</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">; 4], _> </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> bytes[</span><span style="color:#79B8FF">9</span><span style="color:#F97583">..</span><span style="color:#79B8FF">13</span><span style="color:#E1E4E8">]</span><span style="color:#F97583">.</span><span style="color:#B392F0">try_into</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> chain_code</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Result</span><span style="color:#E1E4E8">&#x3C;[</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">; 32], _> </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> bytes[</span><span style="color:#79B8FF">13</span><span style="color:#F97583">..</span><span style="color:#79B8FF">45</span><span style="color:#E1E4E8">]</span><span style="color:#F97583">.</span><span style="color:#B392F0">try_into</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> key</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Result</span><span style="color:#E1E4E8">&#x3C;[</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">; 33], _> </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> bytes[</span><span style="color:#79B8FF">45</span><span style="color:#F97583">..</span><span style="color:#E1E4E8">]</span><span style="color:#F97583">.</span><span style="color:#B392F0">try_into</span><span style="color:#E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#B392F0"> ExtendedKey</span><span style="color:#E1E4E8"> { version_bytes</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> version_bytes</span><span style="color:#F97583">.</span><span style="color:#B392F0">unwrap</span><span style="color:#E1E4E8">(), </span></span>
<span class="line"><span style="color:#E1E4E8">                            depth</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> depth</span><span style="color:#F97583">.</span><span style="color:#B392F0">unwrap</span><span style="color:#E1E4E8">(), </span></span>
<span class="line"><span style="color:#E1E4E8">                            finger_print</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> finger_print</span><span style="color:#F97583">.</span><span style="color:#B392F0">unwrap</span><span style="color:#E1E4E8">(), </span></span>
<span class="line"><span style="color:#E1E4E8">                            child_number</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> child_number</span><span style="color:#F97583">.</span><span style="color:#B392F0">unwrap</span><span style="color:#E1E4E8">(), </span></span>
<span class="line"><span style="color:#E1E4E8">                            chain_code</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> chain_code</span><span style="color:#F97583">.</span><span style="color:#B392F0">unwrap</span><span style="color:#E1E4E8">(), </span></span>
<span class="line"><span style="color:#E1E4E8">                            key</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> key</span><span style="color:#F97583">.</span><span style="color:#B392F0">unwrap</span><span style="color:#E1E4E8">() }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// Derive the secp256k1 compressed public key from a given private key</span></span>
<span class="line"><span style="color:#6A737D">// BONUS POINTS: Implement ECDSA yourself and multiply your key by the generator point!</span></span>
<span class="line"><span style="color:#6A737D">// -> [u8; 33]</span></span>
<span class="line"><span style="color:#F97583">fn</span><span style="color:#B392F0"> derive_public_key_from_private</span><span style="color:#E1E4E8">(key</span><span style="color:#F97583">:</span><span style="color:#F97583"> &#x26;</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">; </span><span style="color:#79B8FF">32</span><span style="color:#E1E4E8">]) </span><span style="color:#F97583">-></span><span style="color:#E1E4E8"> [</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">; </span><span style="color:#79B8FF">33</span><span style="color:#E1E4E8">] {</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> curve </span><span style="color:#F97583">=</span><span style="color:#B392F0"> Secp256k1</span><span style="color:#F97583">::</span><span style="color:#B392F0">new</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> sk </span><span style="color:#F97583">=</span><span style="color:#B392F0"> SecretKey</span><span style="color:#F97583">::</span><span style="color:#B392F0">from_slice</span><span style="color:#E1E4E8">(key)</span></span>
<span class="line"><span style="color:#F97583">                                    .</span><span style="color:#B392F0">expect</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Secret key initializatoin failure."</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> public_key </span><span style="color:#F97583">=</span><span style="color:#B392F0"> PublicKey</span><span style="color:#F97583">::</span><span style="color:#B392F0">from_secret_key</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">curve, </span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">sk);</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> ser</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> [</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">; </span><span style="color:#79B8FF">33</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> public_key</span><span style="color:#F97583">.</span><span style="color:#B392F0">serialize</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> ser</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// Perform a BIP32 parent private key -> child private key operation</span></span>
<span class="line"><span style="color:#6A737D">// Return a JSON object with "key" and "chaincode" properties as bytes</span></span>
<span class="line"><span style="color:#6A737D">// https://github.com/bitcoin/bips/blob/master/bip-0032.mediawiki#user-content-Private_parent_key_rarr_private_child_key</span></span>
<span class="line"><span style="color:#F97583">fn</span><span style="color:#B392F0"> derive_priv_child</span><span style="color:#E1E4E8">(key</span><span style="color:#F97583">:</span><span style="color:#F97583"> &#x26;</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">; </span><span style="color:#79B8FF">32</span><span style="color:#E1E4E8">], chaincode</span><span style="color:#F97583">:</span><span style="color:#F97583"> &#x26;</span><span style="color:#E1E4E8">[</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">; </span><span style="color:#79B8FF">32</span><span style="color:#E1E4E8">], index</span><span style="color:#F97583">:</span><span style="color:#B392F0"> u32</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-></span><span style="color:#B392F0"> ChildKey</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> is_hardened </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> index </span><span style="color:#F97583">>=</span><span style="color:#79B8FF"> HARDENED_OFFSET</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> ser_i </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> index</span><span style="color:#F97583">.</span><span style="color:#B392F0">to_be_bytes</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> hmac_input</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Vec</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">>;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> is_hardened {</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#E1E4E8"> stack</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Vec</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">> </span><span style="color:#F97583">=</span><span style="color:#B392F0"> vec!</span><span style="color:#E1E4E8">[</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">];</span></span>
<span class="line"><span style="color:#E1E4E8">        hmac_input </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> stack</span><span style="color:#F97583">.</span><span style="color:#B392F0">iter</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">.</span><span style="color:#B392F0">chain</span><span style="color:#E1E4E8">(key</span><span style="color:#F97583">.</span><span style="color:#B392F0">iter</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">.</span><span style="color:#B392F0">chain</span><span style="color:#E1E4E8">(ser_i</span><span style="color:#F97583">.</span><span style="color:#B392F0">iter</span><span style="color:#E1E4E8">()))</span><span style="color:#F97583">.</span><span style="color:#B392F0">cloned</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">.</span><span style="color:#B392F0">collect</span><span style="color:#E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    } </span><span style="color:#F97583">else</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#E1E4E8"> pk </span><span style="color:#F97583">=</span><span style="color:#B392F0"> derive_public_key_from_private</span><span style="color:#E1E4E8">(key);</span></span>
<span class="line"><span style="color:#E1E4E8">        hmac_input </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> pk</span><span style="color:#F97583">.</span><span style="color:#B392F0">iter</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">.</span><span style="color:#B392F0">chain</span><span style="color:#E1E4E8">(ser_i</span><span style="color:#F97583">.</span><span style="color:#B392F0">iter</span><span style="color:#E1E4E8">())</span><span style="color:#F97583">.</span><span style="color:#B392F0">cloned</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">.</span><span style="color:#B392F0">collect</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> mac_result </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> HMAC</span><span style="color:#F97583">::</span><span style="color:#B392F0">mac</span><span style="color:#E1E4E8">(hmac_input, chaincode);</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> (child_k, child_chaincode) </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> mac_result</span><span style="color:#F97583">.</span><span style="color:#B392F0">split_at</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">32</span><span style="color:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> cc</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Result</span><span style="color:#E1E4E8">&#x3C;[</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">; 32], _> </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> child_chaincode</span><span style="color:#F97583">.</span><span style="color:#B392F0">try_into</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> cc </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> cc</span><span style="color:#F97583">.</span><span style="color:#B392F0">unwrap</span><span style="color:#E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> big_child </span><span style="color:#F97583">=</span><span style="color:#B392F0"> BigUint</span><span style="color:#F97583">::</span><span style="color:#B392F0">from_bytes_be</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">child_k);</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> big_parent </span><span style="color:#F97583">=</span><span style="color:#B392F0"> BigUint</span><span style="color:#F97583">::</span><span style="color:#B392F0">from_bytes_be</span><span style="color:#E1E4E8">(key);</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> curve_order </span><span style="color:#F97583">=</span><span style="color:#B392F0"> hex</span><span style="color:#F97583">::</span><span style="color:#B392F0">decode</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">CURVE_ORDER</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">.</span><span style="color:#B392F0">unwrap</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> big_order </span><span style="color:#F97583">=</span><span style="color:#B392F0"> BigUint</span><span style="color:#F97583">::</span><span style="color:#B392F0">from_bytes_be</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">curve_order);</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> ck </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> big_child</span><span style="color:#F97583">.</span><span style="color:#B392F0">add</span><span style="color:#E1E4E8">(big_parent)</span><span style="color:#F97583">.</span><span style="color:#B392F0">modpow</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#B392F0">BigUint</span><span style="color:#F97583">::</span><span style="color:#B392F0">new</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">vec!</span><span style="color:#E1E4E8">[</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">]), </span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">big_order);</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> big_endian </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> ck</span><span style="color:#F97583">.</span><span style="color:#B392F0">to_bytes_be</span><span style="color:#E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // let k: Result&#x3C;[u8; 32], _> = big_endian.try_into();</span></span>
<span class="line"><span style="color:#6A737D">    // let k = k.unwrap();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#F97583"> mut</span><span style="color:#E1E4E8"> buffer</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> [</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">; </span><span style="color:#79B8FF">32</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">; </span><span style="color:#79B8FF">32</span><span style="color:#E1E4E8">];</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> start_index </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 32</span><span style="color:#F97583"> -</span><span style="color:#E1E4E8"> big_endian</span><span style="color:#F97583">.</span><span style="color:#B392F0">len</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">    buffer[start_index</span><span style="color:#F97583">..</span><span style="color:#E1E4E8">]</span><span style="color:#F97583">.</span><span style="color:#B392F0">copy_from_slice</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">big_endian);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">    ChildKey</span><span style="color:#E1E4E8"> { priv_key</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> buffer, chain_code</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> cc }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// Given an extended private key and a BIP32 derivation path, compute the child private key found at the last path</span></span>
<span class="line"><span style="color:#6A737D">// The derivation path is formatted as an array of (index: int, hardened: bool) tuples.</span></span>
<span class="line"><span style="color:#F97583">fn</span><span style="color:#B392F0"> get_child_key_at_path</span><span style="color:#E1E4E8">(key</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> [</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">; </span><span style="color:#79B8FF">32</span><span style="color:#E1E4E8">], chaincode</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> [</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">; </span><span style="color:#79B8FF">32</span><span style="color:#E1E4E8">], paths</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Vec</span><span style="color:#E1E4E8">&#x3C;(</span><span style="color:#B392F0">u32</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">bool</span><span style="color:#E1E4E8">)>) </span><span style="color:#F97583">-></span><span style="color:#B392F0"> ChildKey</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#F97583"> mut</span><span style="color:#E1E4E8"> final_child</span><span style="color:#F97583">:</span><span style="color:#B392F0"> ChildKey</span><span style="color:#F97583"> =</span><span style="color:#B392F0"> ChildKey</span><span style="color:#E1E4E8"> { priv_key</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> key, chain_code</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> chaincode };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    for</span><span style="color:#E1E4E8"> (index, is_hardened) </span><span style="color:#F97583">in</span><span style="color:#E1E4E8"> paths {</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#F97583"> mut</span><span style="color:#E1E4E8"> offset </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> index;</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8"> is_hardened { offset </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> index </span><span style="color:#F97583">+</span><span style="color:#79B8FF"> HARDENED_OFFSET</span><span style="color:#E1E4E8"> }</span></span>
<span class="line"><span style="color:#E1E4E8">        final_child </span><span style="color:#F97583">=</span><span style="color:#B392F0"> derive_priv_child</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">final_child</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">priv_key, </span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">final_child</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">chain_code, offset);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> final_child;</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// Compute the first N child private keys.</span></span>
<span class="line"><span style="color:#6A737D">// Return an array of keys encoded as bytes.</span></span>
<span class="line"><span style="color:#F97583">fn</span><span style="color:#B392F0"> get_keys_at_child_key_path</span><span style="color:#E1E4E8">(child_key</span><span style="color:#F97583">:</span><span style="color:#B392F0"> ChildKey</span><span style="color:#E1E4E8">, num_keys</span><span style="color:#F97583">:</span><span style="color:#B392F0"> u32</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-></span><span style="color:#B392F0"> Vec</span><span style="color:#E1E4E8">&#x3C;[</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">; 32]> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#F97583"> mut</span><span style="color:#E1E4E8"> children</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Vec</span><span style="color:#E1E4E8">&#x3C;[</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">; 32]> </span><span style="color:#F97583">=</span><span style="color:#B392F0"> vec!</span><span style="color:#E1E4E8">[];</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    for</span><span style="color:#E1E4E8"> index </span><span style="color:#F97583">in</span><span style="color:#79B8FF"> 0</span><span style="color:#F97583">..</span><span style="color:#E1E4E8">num_keys {</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#E1E4E8"> child </span><span style="color:#F97583">=</span><span style="color:#B392F0"> derive_priv_child</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">child_key</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">priv_key, </span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">child_key</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">chain_code, index);</span></span>
<span class="line"><span style="color:#E1E4E8">        children</span><span style="color:#F97583">.</span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">(child</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">priv_key);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#E1E4E8">    children</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// Derive the p2wpkh witness program (aka scriptPubKey) for a given compressed public key.</span></span>
<span class="line"><span style="color:#6A737D">// Return a bytes array to be compared with the JSON output of Bitcoin Core RPC getblock</span></span>
<span class="line"><span style="color:#6A737D">// so we can find our received transactions in blocks.</span></span>
<span class="line"><span style="color:#6A737D">// These are segwit version 0 pay-to-public-key-hash witness programs.</span></span>
<span class="line"><span style="color:#6A737D">// https://github.com/bitcoin/bips/blob/master/bip-0141.mediawiki#user-content-P2WPKH</span></span>
<span class="line"><span style="color:#F97583">fn</span><span style="color:#B392F0"> get_p2wpkh_program</span><span style="color:#E1E4E8">(pubkey</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> [</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">; </span><span style="color:#79B8FF">33</span><span style="color:#E1E4E8">]) </span><span style="color:#F97583">-></span><span style="color:#E1E4E8"> [</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">; </span><span style="color:#79B8FF">22</span><span style="color:#E1E4E8">] {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    //sha256</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#F97583"> mut</span><span style="color:#E1E4E8"> hasher </span><span style="color:#F97583">=</span><span style="color:#B392F0"> Sha256</span><span style="color:#F97583">::</span><span style="color:#B392F0">new</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">    hasher</span><span style="color:#F97583">.</span><span style="color:#B392F0">write</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">pubkey</span><span style="color:#F97583">.</span><span style="color:#B392F0">clone</span><span style="color:#E1E4E8">())</span><span style="color:#F97583">.</span><span style="color:#B392F0">expect</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Hash failed."</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> first_digest </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> hasher</span><span style="color:#F97583">.</span><span style="color:#B392F0">finalize_fixed</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> digest_bytes </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> first_digest</span><span style="color:#F97583">.</span><span style="color:#B392F0">to_vec</span><span style="color:#E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    //ripemd160</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#F97583"> mut</span><span style="color:#E1E4E8"> hasher </span><span style="color:#F97583">=</span><span style="color:#B392F0"> Ripemd160</span><span style="color:#F97583">::</span><span style="color:#B392F0">new</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">    hasher</span><span style="color:#F97583">.</span><span style="color:#B392F0">write</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">digest_bytes</span><span style="color:#F97583">.</span><span style="color:#B392F0">clone</span><span style="color:#E1E4E8">())</span><span style="color:#F97583">.</span><span style="color:#B392F0">unwrap</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> second_digest </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> hasher</span><span style="color:#F97583">.</span><span style="color:#B392F0">finalize_fixed</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> pkh </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> second_digest</span><span style="color:#F97583">.</span><span style="color:#B392F0">to_vec</span><span style="color:#E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> version_stack </span><span style="color:#F97583">=</span><span style="color:#B392F0"> vec!</span><span style="color:#E1E4E8">[</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">20</span><span style="color:#E1E4E8">];</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> witness_program</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Vec</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">> </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> version_stack</span><span style="color:#F97583">.</span><span style="color:#B392F0">iter</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">.</span><span style="color:#B392F0">chain</span><span style="color:#E1E4E8">(pkh</span><span style="color:#F97583">.</span><span style="color:#B392F0">iter</span><span style="color:#E1E4E8">())</span><span style="color:#F97583">.</span><span style="color:#B392F0">cloned</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">.</span><span style="color:#B392F0">collect</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> witness_try</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Result</span><span style="color:#E1E4E8">&#x3C;[</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">; 22], _> </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> witness_program</span><span style="color:#F97583">.</span><span style="color:#B392F0">try_into</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> witness </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> witness_try</span><span style="color:#F97583">.</span><span style="color:#B392F0">unwrap</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> witness;</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// public function that will be called by `run` here as well as the spend program externally</span></span>
<span class="line"><span style="color:#F97583">pub</span><span style="color:#F97583"> fn</span><span style="color:#B392F0"> recover_wallet_state</span><span style="color:#E1E4E8">(extended_private_key</span><span style="color:#F97583">:</span><span style="color:#F97583"> &#x26;</span><span style="color:#B392F0">str</span><span style="color:#E1E4E8">, cookie_filepath</span><span style="color:#F97583">:</span><span style="color:#F97583"> &#x26;</span><span style="color:#B392F0">str</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-></span><span style="color:#B392F0"> Result</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">WalletState</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">Box</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#F97583">dyn</span><span style="color:#B392F0"> Error</span><span style="color:#E1E4E8">>> {</span></span>
<span class="line"><span style="color:#6A737D">    // Deserialize the provided extended private key</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> ext_key </span><span style="color:#F97583">=</span><span style="color:#B392F0"> deserialize_key</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">base58_decode</span><span style="color:#E1E4E8">(extended_private_key));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // Derive the key and chaincode at the path in the descriptor (`84h/1h/0h/0`)</span></span>
<span class="line"><span style="color:#6A737D">    // Get the child key at the derivation path</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> path</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Vec</span><span style="color:#E1E4E8">&#x3C;(</span><span style="color:#B392F0">u32</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">bool</span><span style="color:#E1E4E8">)> </span><span style="color:#F97583">=</span><span style="color:#B392F0"> vec!</span><span style="color:#E1E4E8">[(</span><span style="color:#79B8FF">84</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">true</span><span style="color:#E1E4E8">), (</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">true</span><span style="color:#E1E4E8">), (</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">true</span><span style="color:#E1E4E8">), (</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">false</span><span style="color:#E1E4E8">)];</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> master_priv_key_try</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Result</span><span style="color:#E1E4E8">&#x3C;[</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">; 32], _> </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> ext_key</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">key[</span><span style="color:#79B8FF">1</span><span style="color:#F97583">..</span><span style="color:#E1E4E8">]</span><span style="color:#F97583">.</span><span style="color:#B392F0">try_into</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> master_priv_key </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> master_priv_key_try</span><span style="color:#F97583">.</span><span style="color:#B392F0">unwrap</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> account_master_key </span><span style="color:#F97583">=</span><span style="color:#B392F0"> get_child_key_at_path</span><span style="color:#E1E4E8">(master_priv_key, ext_key</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">chain_code, path);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // Compute 2000 private keys from the child key path</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> bag_of_keys </span><span style="color:#F97583">=</span><span style="color:#B392F0"> get_keys_at_child_key_path</span><span style="color:#E1E4E8">(account_master_key, </span><span style="color:#79B8FF">2000</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#6A737D">    // For each private key, collect compressed public keys and witness programs</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#F97583"> mut</span><span style="color:#E1E4E8"> private_keys </span><span style="color:#F97583">=</span><span style="color:#B392F0"> vec!</span><span style="color:#E1E4E8">[];</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#F97583"> mut</span><span style="color:#E1E4E8"> public_keys </span><span style="color:#F97583">=</span><span style="color:#B392F0"> vec!</span><span style="color:#E1E4E8">[];</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#F97583"> mut</span><span style="color:#E1E4E8"> witness_programs </span><span style="color:#F97583">=</span><span style="color:#B392F0"> vec!</span><span style="color:#E1E4E8">[];</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    for</span><span style="color:#E1E4E8"> key </span><span style="color:#F97583">in</span><span style="color:#E1E4E8"> bag_of_keys {</span></span>
<span class="line"><span style="color:#E1E4E8">        private_keys</span><span style="color:#F97583">.</span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">(key);</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#E1E4E8"> pk </span><span style="color:#F97583">=</span><span style="color:#B392F0"> derive_public_key_from_private</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">key);</span></span>
<span class="line"><span style="color:#E1E4E8">        public_keys</span><span style="color:#F97583">.</span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">(pk);</span></span>
<span class="line"><span style="color:#E1E4E8">        witness_programs</span><span style="color:#F97583">.</span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">get_p2wpkh_program</span><span style="color:#E1E4E8">(pk))</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // Collect outgoing and spending txs from a block scan</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#F97583"> mut</span><span style="color:#E1E4E8"> outgoing_txs</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Vec</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">OutgoingTx</span><span style="color:#E1E4E8">> </span><span style="color:#F97583">=</span><span style="color:#B392F0"> vec!</span><span style="color:#E1E4E8">[];</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#F97583"> mut</span><span style="color:#E1E4E8"> spending_txs</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Vec</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">SpendingTx</span><span style="color:#E1E4E8">> </span><span style="color:#F97583">=</span><span style="color:#B392F0"> vec!</span><span style="color:#E1E4E8">[];</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#F97583"> mut</span><span style="color:#E1E4E8"> utxos</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Vec</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">OutgoingTx</span><span style="color:#E1E4E8">> </span><span style="color:#F97583">=</span><span style="color:#B392F0"> vec!</span><span style="color:#E1E4E8">[];</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // set up bitcoin-core-rpc on signet</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> path </span><span style="color:#F97583">=</span><span style="color:#B392F0"> PathBuf</span><span style="color:#F97583">::</span><span style="color:#B392F0">from</span><span style="color:#E1E4E8">(cookie_filepath);</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> rpc </span><span style="color:#F97583">=</span><span style="color:#B392F0"> Client</span><span style="color:#F97583">::</span><span style="color:#B392F0">new</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"http://localhost:38332"</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">Auth</span><span style="color:#F97583">::</span><span style="color:#B392F0">CookieFile</span><span style="color:#E1E4E8">(path))</span><span style="color:#F97583">?</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // Scan blocks 0 to 300 for transactions</span></span>
<span class="line"><span style="color:#6A737D">    // Check every tx input (witness) for our own compressed public keys. These are coins we have spent.</span></span>
<span class="line"><span style="color:#6A737D">    // Check every tx output for our own witness programs. These are coins we have received.</span></span>
<span class="line"><span style="color:#6A737D">    // Keep track of outputs by their outpoint so we can check if it was spent later by an input</span></span>
<span class="line"><span style="color:#6A737D">    // Collect outputs that have not been spent into a utxo set</span></span>
<span class="line"><span style="color:#F97583">    for</span><span style="color:#E1E4E8"> block </span><span style="color:#F97583">in</span><span style="color:#79B8FF"> 0</span><span style="color:#F97583">..</span><span style="color:#79B8FF">301</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#E1E4E8"> block_hash </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> rpc</span><span style="color:#F97583">.</span><span style="color:#B392F0">get_block_hash</span><span style="color:#E1E4E8">(block)</span><span style="color:#F97583">.</span><span style="color:#B392F0">unwrap</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#E1E4E8"> block </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> rpc</span><span style="color:#F97583">.</span><span style="color:#B392F0">get_block</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">block_hash)</span><span style="color:#F97583">.</span><span style="color:#B392F0">unwrap</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#E1E4E8"> txs </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> block</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">txdata;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">        for</span><span style="color:#E1E4E8"> tx </span><span style="color:#F97583">in</span><span style="color:#F97583"> &#x26;</span><span style="color:#E1E4E8">txs {</span></span>
<span class="line"><span style="color:#E1E4E8">            </span></span>
<span class="line"><span style="color:#6A737D">            // Check every tx input (witness) for our own compressed public keys. These are coins we have spent.</span></span>
<span class="line"><span style="color:#F97583">            for</span><span style="color:#E1E4E8"> input </span><span style="color:#F97583">in</span><span style="color:#F97583"> &#x26;</span><span style="color:#E1E4E8">tx</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">input {</span></span>
<span class="line"><span style="color:#F97583">                let</span><span style="color:#E1E4E8"> program </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> input</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">witness</span><span style="color:#F97583">.</span><span style="color:#B392F0">to_vec</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">                if</span><span style="color:#E1E4E8"> program</span><span style="color:#F97583">.</span><span style="color:#B392F0">len</span><span style="color:#E1E4E8">() > </span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">                    for</span><span style="color:#E1E4E8"> pk </span><span style="color:#F97583">in</span><span style="color:#F97583"> &#x26;</span><span style="color:#E1E4E8">public_keys {</span></span>
<span class="line"><span style="color:#F97583">                        if</span><span style="color:#E1E4E8"> pk</span><span style="color:#F97583">.</span><span style="color:#B392F0">to_vec</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">.</span><span style="color:#B392F0">eq</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">program[</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">]) {</span></span>
<span class="line"><span style="color:#E1E4E8">                            spending_txs</span><span style="color:#F97583">.</span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">SpendingTx</span><span style="color:#E1E4E8"> { prev_out</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> input</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">previous_output</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">txid</span><span style="color:#F97583">.</span><span style="color:#B392F0">to_string</span><span style="color:#E1E4E8">() })</span></span>
<span class="line"><span style="color:#E1E4E8">                        }</span></span>
<span class="line"><span style="color:#E1E4E8">                    }</span></span>
<span class="line"><span style="color:#E1E4E8">                }</span></span>
<span class="line"><span style="color:#E1E4E8">            }</span></span>
<span class="line"><span style="color:#E1E4E8">            </span></span>
<span class="line"><span style="color:#6A737D">            // Check every tx output for our own witness programs. These are coins we have received.</span></span>
<span class="line"><span style="color:#F97583">            for</span><span style="color:#E1E4E8"> out </span><span style="color:#F97583">in</span><span style="color:#F97583"> &#x26;</span><span style="color:#E1E4E8">tx</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">output {</span></span>
<span class="line"><span style="color:#F97583">                for</span><span style="color:#E1E4E8"> witness </span><span style="color:#F97583">in</span><span style="color:#F97583"> &#x26;</span><span style="color:#E1E4E8">witness_programs {</span></span>
<span class="line"><span style="color:#F97583">                    if</span><span style="color:#E1E4E8"> out</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">script_pubkey</span><span style="color:#F97583">.</span><span style="color:#B392F0">as_bytes</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">.</span><span style="color:#B392F0">eq</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">witness</span><span style="color:#F97583">.</span><span style="color:#B392F0">to_vec</span><span style="color:#E1E4E8">()) {</span></span>
<span class="line"><span style="color:#F97583">                        let</span><span style="color:#E1E4E8"> value </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> out</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">value</span><span style="color:#F97583">.</span><span style="color:#B392F0">to_sat</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">                        let</span><span style="color:#E1E4E8"> txid </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> tx</span><span style="color:#F97583">.</span><span style="color:#B392F0">txid</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">.</span><span style="color:#B392F0">to_string</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">                        let</span><span style="color:#E1E4E8"> received_tx </span><span style="color:#F97583">=</span><span style="color:#B392F0"> OutgoingTx</span><span style="color:#E1E4E8"> { sats</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> value, pointer</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> txid };</span></span>
<span class="line"><span style="color:#E1E4E8">                        outgoing_txs</span><span style="color:#F97583">.</span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">(received_tx);                 </span></span>
<span class="line"><span style="color:#E1E4E8">                    }</span></span>
<span class="line"><span style="color:#E1E4E8">                }            </span></span>
<span class="line"><span style="color:#E1E4E8">            }</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#6A737D">    // Collect outputs that have not been spent into a utxo set</span></span>
<span class="line"><span style="color:#F97583">    for</span><span style="color:#E1E4E8"> spend </span><span style="color:#F97583">in</span><span style="color:#E1E4E8"> spending_txs {</span></span>
<span class="line"><span style="color:#E1E4E8">        outgoing_txs</span><span style="color:#F97583">.</span><span style="color:#B392F0">retain</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">|</span><span style="color:#E1E4E8">x</span><span style="color:#F97583">|</span><span style="color:#E1E4E8"> x</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">pointer </span><span style="color:#F97583">!=</span><span style="color:#E1E4E8"> spend</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">prev_out);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    utxos </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> outgoing_txs;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // Return Wallet State</span></span>
<span class="line"><span style="color:#B392F0">    Ok</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">WalletState</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">        utxos,</span></span>
<span class="line"><span style="color:#E1E4E8">        public_keys,</span></span>
<span class="line"><span style="color:#E1E4E8">        private_keys,</span></span>
<span class="line"><span style="color:#E1E4E8">        witness_programs,</span></span>
<span class="line"><span style="color:#E1E4E8">    })</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">pub</span><span style="color:#F97583"> fn</span><span style="color:#B392F0"> run</span><span style="color:#E1E4E8">(rpc_cookie_filepath</span><span style="color:#F97583">:</span><span style="color:#F97583"> &#x26;</span><span style="color:#B392F0">str</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-></span><span style="color:#B392F0"> Result</span><span style="color:#E1E4E8">&#x3C;(), </span><span style="color:#B392F0">Box</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#F97583">dyn</span><span style="color:#B392F0"> Error</span><span style="color:#E1E4E8">>> {</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> utxos </span><span style="color:#F97583">=</span><span style="color:#B392F0"> recover_wallet_state</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">EXTENDED_PRIVATE_KEY</span><span style="color:#E1E4E8">, rpc_cookie_filepath)</span><span style="color:#F97583">?</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> balance</span><span style="color:#F97583">:</span><span style="color:#B392F0"> u64</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> utxos</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">utxos</span><span style="color:#F97583">.</span><span style="color:#B392F0">iter</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">.</span><span style="color:#B392F0">map</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">|</span><span style="color:#E1E4E8">x</span><span style="color:#F97583">|</span><span style="color:#E1E4E8"> x</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">sats)</span><span style="color:#F97583">.</span><span style="color:#B392F0">sum</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> bitcoin </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> balance </span><span style="color:#F97583">as</span><span style="color:#B392F0"> f64</span><span style="color:#F97583"> /</span><span style="color:#79B8FF"> 100_000_000</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#B392F0">    println!</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"{} {:.8}"</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">WALLET_NAME</span><span style="color:#E1E4E8">, bitcoin);</span></span>
<span class="line"><span style="color:#B392F0">    Ok</span><span style="color:#E1E4E8">(())</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">#[cfg(test)]</span></span>
<span class="line"><span style="color:#F97583">mod</span><span style="color:#B392F0"> tests</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    use</span><span style="color:#79B8FF"> super</span><span style="color:#F97583">::*</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    #[test]</span></span>
<span class="line"><span style="color:#F97583">    fn</span><span style="color:#B392F0"> test_path_derive</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#E1E4E8"> b_58_decode </span><span style="color:#F97583">=</span><span style="color:#B392F0"> base58_decode</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"tprv8ZgxMBicQKsPdpZe8dbST5dNjj5UkA9MDWR9MKZw4vdHoJ27dXZbWSGBE7BgaURHs3A649nhUsKcDvQbGVHUQRY68jHKEu6XzDz4Kq5pWGa"</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#E1E4E8"> ext_priv_key </span><span style="color:#F97583">=</span><span style="color:#B392F0"> deserialize_key</span><span style="color:#E1E4E8">(b_58_decode);</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#E1E4E8"> master_priv_key_try</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Result</span><span style="color:#E1E4E8">&#x3C;[</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">; 32], _> </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> ext_priv_key</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">key[</span><span style="color:#79B8FF">1</span><span style="color:#F97583">..</span><span style="color:#E1E4E8">]</span><span style="color:#F97583">.</span><span style="color:#B392F0">try_into</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#E1E4E8"> master_priv_key </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> master_priv_key_try</span><span style="color:#F97583">.</span><span style="color:#B392F0">unwrap</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#E1E4E8"> path</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Vec</span><span style="color:#E1E4E8">&#x3C;(</span><span style="color:#B392F0">u32</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">bool</span><span style="color:#E1E4E8">)> </span><span style="color:#F97583">=</span><span style="color:#B392F0"> vec!</span><span style="color:#E1E4E8">[(</span><span style="color:#79B8FF">84</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">true</span><span style="color:#E1E4E8">), (</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">true</span><span style="color:#E1E4E8">), (</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">true</span><span style="color:#E1E4E8">), (</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">false</span><span style="color:#E1E4E8">), (</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">false</span><span style="color:#E1E4E8">)];</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#E1E4E8"> first_addr_priv_key </span><span style="color:#F97583">=</span><span style="color:#B392F0"> get_child_key_at_path</span><span style="color:#E1E4E8">(master_priv_key, ext_priv_key</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">chain_code, path);</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#E1E4E8"> first_addr_pk </span><span style="color:#F97583">=</span><span style="color:#B392F0"> derive_public_key_from_private</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">first_addr_priv_key</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">priv_key);</span></span>
<span class="line"><span style="color:#B392F0">        assert_eq!</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">hex</span><span style="color:#F97583">::</span><span style="color:#B392F0">encode</span><span style="color:#E1E4E8">(first_addr_pk), </span><span style="color:#9ECBFF">"020147a645bf92b4b36a63285e4ac53636e8b6d5086bd1686092c6387ae80bca9a"</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    #[test]</span></span>
<span class="line"><span style="color:#F97583">    fn</span><span style="color:#B392F0"> test_one_nonhardened_child_key</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#E1E4E8"> b_58_decode </span><span style="color:#F97583">=</span><span style="color:#B392F0"> base58_decode</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"tprv8ijZZJYvoMqbPnvPdXUMXX8Y8VGoJeVVHqcciuy13T5SpktP5LHzbM38Zqcr4FbTpEBSUi62PpwWg18aPjE69Q6fG6Eyrqi9DnBfay6LYUa"</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#E1E4E8"> ext_priv_key </span><span style="color:#F97583">=</span><span style="color:#B392F0"> deserialize_key</span><span style="color:#E1E4E8">(b_58_decode);</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#E1E4E8"> master_priv_key_try</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Result</span><span style="color:#E1E4E8">&#x3C;[</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">; 32], _> </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> ext_priv_key</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">key[</span><span style="color:#79B8FF">1</span><span style="color:#F97583">..</span><span style="color:#E1E4E8">]</span><span style="color:#F97583">.</span><span style="color:#B392F0">try_into</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#E1E4E8"> master_priv_key </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> master_priv_key_try</span><span style="color:#F97583">.</span><span style="color:#B392F0">unwrap</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#E1E4E8"> ck </span><span style="color:#F97583">=</span><span style="color:#B392F0"> derive_priv_child</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">master_priv_key, </span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">ext_priv_key</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">chain_code, </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#E1E4E8"> pk </span><span style="color:#F97583">=</span><span style="color:#B392F0"> derive_public_key_from_private</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">ck</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">priv_key);</span></span>
<span class="line"><span style="color:#B392F0">        assert_eq!</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">hex</span><span style="color:#F97583">::</span><span style="color:#B392F0">encode</span><span style="color:#E1E4E8">(pk), </span><span style="color:#9ECBFF">"020147a645bf92b4b36a63285e4ac53636e8b6d5086bd1686092c6387ae80bca9a"</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    #[test]</span></span>
<span class="line"><span style="color:#F97583">    fn</span><span style="color:#B392F0"> test_first_n</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#E1E4E8"> b_58_decode </span><span style="color:#F97583">=</span><span style="color:#B392F0"> base58_decode</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"tprv8gwhSstZCAiemyBm44HMnUnmvuDpwuPQwnUPQB9Ggx5665BSNowtJCddmpVZBv4GmZEaeUXpyCD3RVvBA96kBwWQXdWp5FisWpgYqw7tVZU"</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#E1E4E8"> ext_priv_key </span><span style="color:#F97583">=</span><span style="color:#B392F0"> deserialize_key</span><span style="color:#E1E4E8">(b_58_decode);</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#E1E4E8"> master_priv_key_try</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Result</span><span style="color:#E1E4E8">&#x3C;[</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">; 32], _> </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> ext_priv_key</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">key[</span><span style="color:#79B8FF">1</span><span style="color:#F97583">..</span><span style="color:#E1E4E8">]</span><span style="color:#F97583">.</span><span style="color:#B392F0">try_into</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#E1E4E8"> master_priv_key </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> master_priv_key_try</span><span style="color:#F97583">.</span><span style="color:#B392F0">unwrap</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#E1E4E8"> ck </span><span style="color:#F97583">=</span><span style="color:#B392F0"> derive_priv_child</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">master_priv_key, </span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">ext_priv_key</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">chain_code, </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#E1E4E8"> bag_of_keys </span><span style="color:#F97583">=</span><span style="color:#B392F0"> get_keys_at_child_key_path</span><span style="color:#E1E4E8">(ck, </span><span style="color:#79B8FF">3</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">        for</span><span style="color:#E1E4E8"> child </span><span style="color:#F97583">in</span><span style="color:#E1E4E8"> bag_of_keys</span><span style="color:#F97583">.</span><span style="color:#B392F0">iter</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#F97583">            let</span><span style="color:#E1E4E8"> pk</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> [</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">; </span><span style="color:#79B8FF">33</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">=</span><span style="color:#B392F0"> derive_public_key_from_private</span><span style="color:#E1E4E8">(child);</span></span>
<span class="line"><span style="color:#B392F0">            println!</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"{:?}"</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">hex</span><span style="color:#F97583">::</span><span style="color:#B392F0">encode</span><span style="color:#E1E4E8">(pk));</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    #[test]</span></span>
<span class="line"><span style="color:#F97583">    fn</span><span style="color:#B392F0"> test_one_priv_to_pub</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#E1E4E8"> hex_k </span><span style="color:#F97583">=</span><span style="color:#9ECBFF"> "1E99423A4ED27608A15A2616A2B0E9E52CED330AC530EDCC32C8FFC6A526AEDD"</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#E1E4E8"> k_as_arr </span><span style="color:#F97583">=</span><span style="color:#B392F0"> hex</span><span style="color:#F97583">::</span><span style="color:#B392F0">decode</span><span style="color:#E1E4E8">(hex_k)</span><span style="color:#F97583">.</span><span style="color:#B392F0">unwrap</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#E1E4E8"> k_try</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Result</span><span style="color:#E1E4E8">&#x3C;[</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">; 32], _> </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> k_as_arr</span><span style="color:#F97583">.</span><span style="color:#B392F0">try_into</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#E1E4E8"> k </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> k_try</span><span style="color:#F97583">.</span><span style="color:#B392F0">unwrap</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#E1E4E8"> pk </span><span style="color:#F97583">=</span><span style="color:#B392F0"> derive_public_key_from_private</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">k);</span></span>
<span class="line"><span style="color:#B392F0">        assert_eq!</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">hex</span><span style="color:#F97583">::</span><span style="color:#B392F0">encode</span><span style="color:#E1E4E8">(pk)</span><span style="color:#F97583">.</span><span style="color:#B392F0">to_uppercase</span><span style="color:#E1E4E8">(), </span><span style="color:#9ECBFF">"03F028892BAD7ED57D2FB57BF33081D5CFCF6F9ED3D3D7F159C2E2FFF579DC341A"</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    #[test]</span></span>
<span class="line"><span style="color:#F97583">    fn</span><span style="color:#B392F0"> test_witness_program</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#E1E4E8"> hex_k </span><span style="color:#F97583">=</span><span style="color:#9ECBFF"> "1E99423A4ED27608A15A2616A2B0E9E52CED330AC530EDCC32C8FFC6A526AEDD"</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#E1E4E8"> k_as_arr </span><span style="color:#F97583">=</span><span style="color:#B392F0"> hex</span><span style="color:#F97583">::</span><span style="color:#B392F0">decode</span><span style="color:#E1E4E8">(hex_k)</span><span style="color:#F97583">.</span><span style="color:#B392F0">unwrap</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#E1E4E8"> k_try</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Result</span><span style="color:#E1E4E8">&#x3C;[</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">; 32], _> </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> k_as_arr</span><span style="color:#F97583">.</span><span style="color:#B392F0">try_into</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#E1E4E8"> k </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> k_try</span><span style="color:#F97583">.</span><span style="color:#B392F0">unwrap</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#E1E4E8"> pk </span><span style="color:#F97583">=</span><span style="color:#B392F0"> derive_public_key_from_private</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">k);</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#E1E4E8"> witness </span><span style="color:#F97583">=</span><span style="color:#B392F0"> get_p2wpkh_program</span><span style="color:#E1E4E8">(pk);</span></span>
<span class="line"><span style="color:#B392F0">        println!</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"{:?}"</span><span style="color:#E1E4E8">, witness);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    #[test]</span></span>
<span class="line"><span style="color:#F97583">    fn</span><span style="color:#B392F0"> test_rpc_connection</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#E1E4E8"> path </span><span style="color:#F97583">=</span><span style="color:#9ECBFF"> r"/Users/robertnetzke/Library/Application Support/Bitcoin/signet/.cookie"</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#E1E4E8"> rpc </span><span style="color:#F97583">=</span><span style="color:#B392F0"> Client</span><span style="color:#F97583">::</span><span style="color:#B392F0">new</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"http://localhost:38332"</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">Auth</span><span style="color:#F97583">::</span><span style="color:#B392F0">CookieFile</span><span style="color:#E1E4E8">(path</span><span style="color:#F97583">.</span><span style="color:#B392F0">into</span><span style="color:#E1E4E8">()))</span><span style="color:#F97583">.</span><span style="color:#B392F0">expect</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Connection failed."</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#E1E4E8"> h </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> rpc</span><span style="color:#F97583">.</span><span style="color:#B392F0">get_best_block_hash</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">.</span><span style="color:#B392F0">expect</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Failed to get block hash"</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#B392F0">        println!</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"{:?}"</span><span style="color:#E1E4E8">, h);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    #[test]</span></span>
<span class="line"><span style="color:#F97583">    fn</span><span style="color:#B392F0"> test_len</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#F97583">        let</span><span style="color:#E1E4E8"> ln </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [</span><span style="color:#79B8FF">253</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">238</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">150</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">214</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">253</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">188</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">109</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">105</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">201</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">30</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">244</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">241</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">216</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">206</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">247</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">217</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">204</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">116</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">137</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">7</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">99</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">3</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">77</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">50</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">23</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">31</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">74</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">23</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">94</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">115</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">90</span><span style="color:#E1E4E8">]</span><span style="color:#F97583">.</span><span style="color:#B392F0">len</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#B392F0">        println!</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"{:?}"</span><span style="color:#E1E4E8">, ln);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </article>  </div>  </main> <footer class="animate"> <div class="mx-auto max-w-screen-sm px-5">  <div class="relative"> <div class="absolute right-0 -top-20"> <button id="back-to-top" class="relative group w-fit flex pl-8 pr-3 py-1.5 flex-nowrap rounded border border-black/15 dark:border-white/20 hover:bg-black/5 dark:hover:bg-white/5 hover:text-black dark:hover:text-white transition-colors duration-300 ease-in-out"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="absolute top-1/2 left-2 -translate-y-1/2 size-4 stroke-2 fill-none stroke-current rotate-90"> <line x1="5" y1="12" x2="19" y2="12" class="translate-x-2 group-hover:translate-x-0 scale-x-0 group-hover:scale-x-100 transition-transform duration-300 ease-in-out"></line> <polyline points="12 5 5 12 12 19" class="translate-x-1 group-hover:translate-x-0 transition-transform duration-300 ease-in-out"></polyline> </svg> <div class="text-sm">
Back to top
</div> </button> </div> </div> <div class="flex justify-between items-center"> <div>
&copy; 2024 | @rustaceanrob </div> <div class="flex flex-wrap gap-1 items-center"> <button id="light-theme-button" aria-label="Light theme" class="group size-8 flex items-center justify-center rounded-full"> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="group-hover:stroke-black group-hover:dark:stroke-white transition-colors duration-300 ease-in-out"> <circle cx="12" cy="12" r="5"></circle> <line x1="12" y1="1" x2="12" y2="3"></line> <line x1="12" y1="21" x2="12" y2="23"></line> <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line> <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line> <line x1="1" y1="12" x2="3" y2="12"></line> <line x1="21" y1="12" x2="23" y2="12"></line> <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line> <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line> </svg> </button> <button id="dark-theme-button" aria-label="Dark theme" class="group size-8 flex items-center justify-center rounded-full"> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="group-hover:stroke-black group-hover:dark:stroke-white transition-colors duration-300 ease-in-out"> <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path> </svg> </button> <button id="system-theme-button" aria-label="System theme" class="group size-8 flex items-center justify-center rounded-full"> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="group-hover:stroke-black group-hover:dark:stroke-white transition-colors duration-300 ease-in-out"> <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect> <line x1="8" y1="21" x2="16" y2="21"></line> <line x1="12" y1="17" x2="12" y2="21"></line> </svg> </button> </div> </div>  </div> </footer> </body></html>